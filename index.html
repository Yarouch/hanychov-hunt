<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanychov Hunt ‚Äì Prototype</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #0b1220;
      color: #e5e7eb;
      overscroll-behavior: none;
    }

    /* ============================================================
       HLAVN√ç GRID
       ≈ò√°dky: header | mapa (1fr) | panel-ot√°zky (0 nebo auto) | footer
       Mapa dostane v≈ædy zb√Ωvaj√≠c√≠ v√Ω≈°ku p≈ôes 1fr ‚Äî nikdy se
       nep≈ôekryje ani neskryje.
    ============================================================ */
    #app {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      /* ≈Ω√ÅDN√ù transform na #app */
    }

    /* ===== HEADER ===== */
    #appHeader {
      padding: 10px 14px;
      padding-top: max(10px, env(safe-area-inset-top));
      display: flex; gap: 10px; align-items: center;
      justify-content: space-between; flex-wrap: wrap;
      background: #111827;
      border-bottom: 1px solid #1f2937;
    }
    .left { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    h1.title { font-size: 14px; margin: 0; font-weight: 700; }
    .badge {
      font-size: 12px; padding: 3px 8px;
      border: 1px solid #374151; border-radius: 999px; color: #cbd5e1;
    }
    .pill {
      padding: 3px 8px; border-radius: 999px;
      border: 1px solid #374151; font-size: 12px; color: #cbd5e1;
    }

    /* ===== MAPA ===== */
    #map {
      width: 100%;
      min-height: 0; /* grid fix ‚Äî bez toho 1fr nefunguje spr√°vnƒõ */
    }
    .leaflet-pane,
    .leaflet-control,
    .leaflet-top,
    .leaflet-bottom { z-index: 10 !important; }
    .leaflet-popup  { z-index: 20 !important; }

    /* ===== PANEL OT√ÅZKY =====
       Skryt√Ω:   max-height:0, overflow:hidden  ‚Üí zab√≠r√° 0px v gridu
       Viditeln√Ω: max-height:50vh, overflow-y:auto ‚Üí vnit≈ôn√≠ scroll
       CSS transition d√° plynul√Ω slide-up efekt.
    ===== */
    #questionPanel {
      background: #111827;
      border-top: 2px solid #2563eb;
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease;
    }
    #questionPanel.open {
      max-height: 50vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .panel-inner { padding: 14px; display: grid; gap: 10px; }

    .panel-header {
      display: flex; justify-content: space-between;
      align-items: center; gap: 8px;
    }
    .panel-title { font-size: 13px; font-weight: 700; color: #93c5fd; }

    .timer {
      font-weight: 900; font-size: 14px; letter-spacing: .5px;
      padding: 3px 10px; border-radius: 999px;
      border: 1px solid #374151; color: #fbbf24;
    }
    .timer.urgent { color: #f87171; border-color: rgba(239,68,68,.4); }

    .q { font-size: 15px; font-weight: 800; line-height: 1.4; }

    .opts { display: grid; gap: 7px; }
    .opt {
      display: flex; gap: 10px; align-items: center;
      padding: 11px 12px;
      border: 1px solid #374151; border-radius: 10px;
      cursor: pointer; font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .opt input[type="radio"] { flex-shrink: 0; transform: scale(1.2); }
    .opt:hover, .opt:focus-within { border-color: #6b7280; }
    .opt.selected { border-color: #2563eb; background: rgba(37,99,235,.08); }

    .result {
      padding: 10px 12px; border-radius: 10px;
      border: 1px solid #374151; font-size: 13px; line-height: 1.5;
    }
    .ok  { border-color: rgba(34,197,94,.5);  background: rgba(34,197,94,.06); }
    .bad { border-color: rgba(239,68,68,.5);  background: rgba(239,68,68,.06); }

    .panel-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* ===== FOOTER ===== */
    #appFooter {
      padding: 10px 14px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #111827;
      border-top: 1px solid #1f2937;
      display: grid; gap: 8px;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .stat { font-size: 13px; color: #cbd5e1; }
    .stat b { color: #e5e7eb; }
    .muted { color: #9ca3af; font-size: 11px; }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas;
      font-size: 11px; padding: 1px 5px;
      border: 1px solid #374151; border-radius: 6px; color: #cbd5e1;
    }

    /* ===== TLAƒå√çTKA ===== */
    button {
      appearance: none;
      border: 1px solid #374151; background: #0b1220; color: #e5e7eb;
      border-radius: 10px; padding: 9px 13px;
      font-weight: 700; font-size: 13px;
      min-height: 40px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active { opacity: .75; }
    button.primary {
      background: #1d4ed8; border-color: #2563eb; color: #fff;
    }
    button.primary:active { background: #1e40af; }
    button:disabled { opacity: .4; cursor: default; }

    /* Pill p≈ôezd√≠vky ‚Äî klikateln√Ω pro zmƒõnu */
    #nickPill { cursor: pointer; transition: border-color .15s; }
    #nickPill:hover { border-color: #6b7280; }

    /* ===== NICKNAME OVERLAY =====
       Vlastn√≠ formul√°≈ô m√≠sto prompt() ‚Äî prompt() je v PWA/standalone
       na iOS Safari nespolehliv√Ω (m≈Ø≈æe b√Ωt ti≈°e ignorov√°n).
    ===== */
    #nickOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.75);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
      z-index: 1000;
    }
    #nickOverlay.hidden { display: none; }
    #nickCard {
      width: min(360px, 100%);
      background: #111827;
      border: 1px solid #374151;
      border-radius: 16px;
      padding: 24px;
      display: grid; gap: 16px;
    }
    #nickCard h2 { margin: 0; font-size: 18px; font-weight: 800; }
    #nickCard p  { margin: 0; font-size: 13px; color: #9ca3af; line-height: 1.5; }
    #nickInput {
      width: 100%;
      background: #0b1220; border: 1px solid #374151;
      color: #e5e7eb; border-radius: 10px;
      padding: 12px 14px; font-size: 16px; /* 16px zabr√°n√≠ zoom na iOS */
      outline: none; box-sizing: border-box;
    }
    #nickInput:focus { border-color: #2563eb; }
    #nickError { color: #f87171; font-size: 12px; min-height: 16px; }

    /* ≈Ωeb≈ô√≠ƒçek ‚Äî pr√°zdn√Ω stav */
    .lb-empty {
      padding: 32px 0; text-align: center;
      color: #6b7280; font-size: 13px;
    }

    /* ===== DRAWER ‚Äî MIMO #app ‚Üí position:fixed = viewport ===== */
    .drawer {
      position: fixed; right: 0; top: 0;
      height: 100%; width: min(400px, 92vw);
      background: #0b1220; border-left: 1px solid #1f2937;
      transform: translateX(100%); transition: transform .25s ease;
      display: grid; grid-template-rows: auto 1fr auto;
      z-index: 500;
      will-change: transform;
    }
    .drawer.open { transform: translateX(0); }
    .drawer-header {
      padding: 12px 14px;
      padding-top: max(12px, env(safe-area-inset-top));
      background: #111827; border-bottom: 1px solid #1f2937;
      display: flex; gap: 10px; align-items: center; justify-content: space-between;
    }
    .drawer-body { padding: 14px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .drawer-footer {
      padding: 12px 14px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      border-top: 1px solid #1f2937;
      display: flex; gap: 10px; justify-content: space-between;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 9px 8px; border-bottom: 1px solid #1f2937; font-size: 13px; text-align: left; }
    th { color: #cbd5e1; font-size: 11px; text-transform: uppercase; letter-spacing: .6px; }
  </style>
</head>
<body>

  <!-- ===== HLAVN√ç LAYOUT ===== -->
  <div id="app">

    <header id="appHeader">
      <div class="left">
        <h1 class="title">Hanychov Hunt ‚Äì Prototype</h1>
        <span id="status" class="badge">ƒåek√°m na GPS‚Ä¶</span>
      </div>
      <div class="left">
        <span class="pill" id="nickPill">P≈ôezd√≠vka: ‚Äî</span>
        <button id="btnLeaderboard">≈Ωeb≈ô√≠ƒçek</button>
      </div>
    </header>

    <!-- Mapa ‚Äî v≈ædy v gridu na sv√©m m√≠stƒõ, dostane 1fr -->
    <div id="map"></div>

    <!-- Panel ot√°zky ‚Äî vysunou se pod mapu, mapa z≈Østane nedotƒçen√° -->
    <section id="questionPanel" aria-live="polite" aria-label="√ökol">
      <div class="panel-inner">

        <div class="panel-header">
          <div class="left">
            <span class="panel-title" id="pointNameLabel">‚Äî</span>
            <span class="badge" id="pointsBadge">‚Äî</span>
          </div>
          <span class="timer" id="timer">03:00</span>
        </div>

        <div class="q" id="questionText">‚Äî</div>

        <div class="opts">
          <label class="opt"><input type="radio" name="ans" value="a"><span><b>A)</b> <span id="optA"></span></span></label>
          <label class="opt"><input type="radio" name="ans" value="b"><span><b>B)</b> <span id="optB"></span></span></label>
          <label class="opt"><input type="radio" name="ans" value="c"><span><b>C)</b> <span id="optC"></span></span></label>
          <label class="opt"><input type="radio" name="ans" value="d"><span><b>D)</b> <span id="optD"></span></span></label>
        </div>

        <div id="resultBox" class="result" style="display:none;"></div>

        <div class="panel-actions">
          <button class="primary" id="btnSubmit">Odeslat odpovƒõƒè</button>
          <button id="btnClosePanel">Zav≈ô√≠t</button>
        </div>

      </div>
    </section>

    <footer id="appFooter">
      <div class="row">
        <div class="stat">Body: <b id="score">0</b></div>
        <div class="stat">U≈°et≈ôen√Ω ƒças: <b id="saved">0:00</b></div>
        <div class="stat">GPS: <b id="acc">‚Äî</b></div>
      </div>
      <div class="row">
        <button id="btnCenter">Centrovat na mƒõ</button>
        <button id="btnReset">Reset prototypu</button>
      </div>
      <div class="muted">
        Tip: Geolokace funguje na <span class="kbd">https</span> nebo <span class="kbd">localhost</span>.
      </div>
    </footer>

  </div><!-- /#app -->

  <!-- ===== NICKNAME OVERLAY (mimo #app) ===== -->
  <div id="nickOverlay" class="hidden" role="dialog" aria-modal="true" aria-labelledby="nickTitle">
    <div id="nickCard">
      <h2 id="nickTitle">V√≠tej v Hanychov Hunt! üëã</h2>
      <p>Zadej p≈ôezd√≠vku, pod kterou se zobraz√≠≈° v ≈æeb≈ô√≠ƒçku. M≈Ø≈æe≈° ji kdykoli zmƒõnit klepnut√≠m na sv√© jm√©no v hlaviƒçce.</p>
      <input id="nickInput" type="text" maxlength="30" placeholder="Nap≈ô. Rychlono≈æka" autocomplete="off" />
      <div id="nickError"></div>
      <button class="primary" id="btnNickConfirm">Zaƒç√≠t hr√°t ‚Üí</button>
    </div>
  </div>


  <!-- ===== DRAWER mimo #app ‚Äî position:fixed vzta≈æen ke skuteƒçn√©mu viewportu ===== -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="left">
        <h1 style="font-size:14px;margin:0;">≈Ωeb≈ô√≠ƒçek (lok√°lnƒõ)</h1>
        <span class="badge">Prototype</span>
      </div>
      <button id="btnCloseDrawer">Zav≈ô√≠t</button>
    </div>
    <div class="drawer-body">
      <p class="muted" style="margin:0 0 10px;">
        Lok√°ln√≠ ≈æeb≈ô√≠ƒçek ‚Äì pro v≈°echny hr√°ƒçe p≈ôid√°me Supabase/Firebase.
      </p>
      <table>
        <thead><tr><th>#</th><th>P≈ôezd√≠vka</th><th>Body</th><th>U≈°et≈ô. ƒças</th><th>Datum</th></tr></thead>
        <tbody id="lbBody"></tbody>
      </table>
    </div>
    <div class="drawer-footer">
      <button id="btnSaveRun">Ulo≈æit bƒõh</button>
      <button id="btnClearLb">Smazat ≈æeb≈ô√≠ƒçek</button>
    </div>
  </aside>


  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ===== 1) KONFIGURACE BOD≈Æ =====
    const TARGETS = [
      {
        id: "za-domovem-558",
        name: "Za Domovem 558",
        lat: 50.7394476,
        lng: 15.0092092,
        points: 100,
        question: {
          text: "Kolik...?",
          options: { a: "1", b: "2", c: "3", d: "4" },
          correct: "a"
        }
      },
      {
        id: "hasicska-zbrojnice",
        name: "Hasiƒçsk√° zbrojnice",
        lat: 50.7399112,
        lng: 15.0185144,
        points: 300,
        question: {
          text: "V jak√©m roce byl zalo≈æen m√≠stn√≠ sbor dobrovoln√Ωch hasiƒç≈Ø?",
          options: { a: "1899", b: "1900", c: "1901", d: "1902" },
          correct: "c"
        }
      },
      {
        id: "spaleniste",
        name: "Sp√°leni≈°tƒõ",
        lat: 50.7402846,
        lng: 15.0169694,
        points: 500,
        question: {
          text: "V jak√©m roce vyho≈ôela m√≠stn√≠ restaurace ‚ÄûZum Walhalla"?",
          options: { a: "1918", b: "1942", c: "1945", d: "1968" },
          correct: "b"
        }
      }
    ];

    // ===== 2) STAV =====
    const LS_KEY = "hanychov_hunt_state_v2"; // v2 ‚Äî nov√Ω kl√≠ƒç, ƒçist√Ω reset po p≈ôid√°n√≠ bod≈Ø
    const LS_LB  = "hanychov_hunt_lb_v1";

    const defaultClosed   = Object.fromEntries(TARGETS.map(t => [t.id, false]));
    const defaultAnswered = Object.fromEntries(TARGETS.map(t => [t.id, false]));

    const state = loadState() ?? {
      nickname: "", score: 0, savedSeconds: 0,
      closed:   { ...defaultClosed },
      answered: { ...defaultAnswered },
    };

    // Aktu√°ln√≠ bod, pro kter√Ω je panel otev≈ôen
    let activeTarget = null;

    // ===== 3) DOM REFS =====
    const elStatus       = document.getElementById("status");
    const elScore        = document.getElementById("score");
    const elSaved        = document.getElementById("saved");
    const elAcc          = document.getElementById("acc");
    const elNickPill     = document.getElementById("nickPill");
    const questionPanel  = document.getElementById("questionPanel");
    const pointNameLabel = document.getElementById("pointNameLabel");
    const pointsBadge    = document.getElementById("pointsBadge");
    const questionText   = document.getElementById("questionText");
    const optA           = document.getElementById("optA");
    const optB           = document.getElementById("optB");
    const optC           = document.getElementById("optC");
    const optD           = document.getElementById("optD");
    const resultBox      = document.getElementById("resultBox");
    const btnSubmit      = document.getElementById("btnSubmit");
    const btnClosePanel  = document.getElementById("btnClosePanel");
    const elTimer        = document.getElementById("timer");
    const drawer         = document.getElementById("drawer");
    const lbBody         = document.getElementById("lbBody");

    // ===== 4) MAPA =====
    // St≈ôed mapy = geometrick√Ω st≈ôed v≈°ech bod≈Ø
    const centerLat = TARGETS.reduce((s,t) => s + t.lat, 0) / TARGETS.length;
    const centerLng = TARGETS.reduce((s,t) => s + t.lng, 0) / TARGETS.length;
    const map = L.map("map").setView([centerLat, centerLng], 15);

    L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution: "Map data ¬© OpenStreetMap contributors | ¬© OpenTopoMap"
    }).addTo(map);

    // Markery a z√≥nov√© kruhy pro ka≈æd√Ω bod
    const markerMap = {};   // id ‚Üí L.marker
    const zoneMap   = {};   // id ‚Üí L.circle

    TARGETS.forEach(t => {
      const m = L.marker([t.lat, t.lng]).addTo(map);
      m.bindPopup(`<b>${t.name}</b><br/>${t.points} bod≈Ø`);
      markerMap[t.id] = m;

      const z = L.circle([t.lat, t.lng],
        { radius: 25, weight: 2, color: "#2563eb", fillOpacity: .08 }).addTo(map);
      zoneMap[t.id] = z;
    });

    let userMarker = null, accCircle = null, lastFix = null;

    // Po animaci panelu p≈ôepoƒç√≠t√°me velikost mapy
    function invalidateMap() { setTimeout(() => map.invalidateSize(), 320); }

    // ===== 5) HELPERY =====
    function loadState() { try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); renderStats(); renderMarkerState(); }
    function fmt(s)      { return `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`; }
    function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
    function dist(la1,lo1,la2,lo2) {
      const R=6371000, r=d=>d*Math.PI/180, dLa=r(la2-la1), dLo=r(lo2-lo1);
      const a=Math.sin(dLa/2)**2+Math.cos(r(la1))*Math.cos(r(la2))*Math.sin(dLo/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function calcR(ac) { return !ac||!isFinite(ac)?25:clamp(Math.round(ac*1.2),10,50); }
    function esc(s) { return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c])); }

    // ===== 6) NICKNAME ‚Äî vlastn√≠ overlay m√≠sto prompt() =====
    const nickOverlay   = document.getElementById("nickOverlay");
    const nickInput     = document.getElementById("nickInput");
    const nickError     = document.getElementById("nickError");
    const btnNickConfirm = document.getElementById("btnNickConfirm");

    function showNickOverlay(prefill = "") {
      nickInput.value  = prefill;
      nickError.textContent = "";
      nickOverlay.classList.remove("hidden");
      // Focus po kr√°tk√© prodlevƒõ ‚Äî iOS pot≈ôebuje ƒças po zobrazen√≠
      setTimeout(() => nickInput.focus(), 120);
    }

    function hideNickOverlay() {
      nickOverlay.classList.add("hidden");
    }

    function confirmNick() {
      const val = nickInput.value.trim();
      if (val.length < 2) {
        nickError.textContent = "P≈ôezd√≠vka mus√≠ m√≠t aspo≈à 2 znaky.";
        nickInput.focus();
        return;
      }
      state.nickname = val;
      saveState();
      hideNickOverlay();
    }

    btnNickConfirm.addEventListener("click", confirmNick);
    nickInput.addEventListener("keydown", e => { if (e.key === "Enter") confirmNick(); });

    // Klik na pill v headeru ‚Üí zmƒõna p≈ôezd√≠vky
    document.getElementById("nickPill").addEventListener("click", () => {
      showNickOverlay(state.nickname);
    });

    function ensureNick() {
      if (state.nickname?.trim().length >= 2) return;
      showNickOverlay("");
    }

    // ===== 7) RENDER =====
    function renderStats() {
      elScore.textContent    = state.score;
      elSaved.textContent    = fmt(state.savedSeconds);
      elNickPill.textContent = `P≈ôezd√≠vka: ${state.nickname||"‚Äî"}`;
    }
    function renderMarkerState() {
      TARGETS.forEach(t => {
        const c = !!state.closed[t.id];
        markerMap[t.id].setOpacity(c ? 0.45 : 1);
        markerMap[t.id].bindPopup(c
          ? `<b>${t.name}</b><br/>Uzav≈ôeno ‚Äî z√≠sk√°no: ${state.answered[t.id] ? t.points : 0} bod≈Ø`
          : `<b>${t.name}</b><br/>${t.points} bod≈Ø`);
      });
    }

    // Vizu√°ln√≠ highlight vybran√© mo≈ænosti
    document.querySelectorAll('input[name="ans"]').forEach(r =>
      r.addEventListener("change", () => {
        document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));
        r.closest(".opt")?.classList.add("selected");
      })
    );

    // ===== 8) PANEL OT√ÅZKY =====
    let timerInt = null, remaining = 180, panelOpen = false;

    function openPanel(target) {
      map.closePopup();
      if (panelOpen || state.closed[target.id]) return;
      activeTarget = target;
      panelOpen = true;
      remaining = 180;

      // reset UI
      resultBox.style.display = "none";
      resultBox.className = "result";
      btnSubmit.disabled = false;
      document.querySelectorAll('input[name="ans"]').forEach(r => r.checked = false);
      document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));

      // naplnit
      pointNameLabel.textContent = target.name;
      pointsBadge.textContent    = `${target.points} bod≈Ø`;
      questionText.textContent   = target.question.text;
      optA.textContent = target.question.options.a;
      optB.textContent = target.question.options.b;
      optC.textContent = target.question.options.c;
      optD.textContent = target.question.options.d;
      elTimer.textContent = "03:00";
      elTimer.classList.remove("urgent");

      questionPanel.classList.add("open");
      invalidateMap();

      timerInt = setInterval(() => {
        remaining--;
        elTimer.textContent = fmt(remaining);
        if (remaining <= 30) elTimer.classList.add("urgent");
        if (remaining <= 0) closeAsTimeout();
      }, 1000);
    }

    function closePanel() {
      questionPanel.classList.remove("open");
      panelOpen = false;
      activeTarget = null;
      elTimer.classList.remove("urgent");
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      invalidateMap();
    }

    function closeAsTimeout() {
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      const t = activeTarget;
      state.closed[t.id]   = true;
      state.answered[t.id] = false;
      resultBox.style.display = "block";
      resultBox.className = "result bad";
      resultBox.textContent = `ƒåas vypr≈°el. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;
      setTimeout(() => { closePanel(); saveState(); }, 2000);
    }

    btnSubmit.addEventListener("click", () => {
      if (btnSubmit.disabled || !activeTarget) return;
      const chosen = document.querySelector('input[name="ans"]:checked')?.value;
      if (!chosen) { alert("Vyber jednu odpovƒõƒè."); return; }
      if (timerInt) { clearInterval(timerInt); timerInt = null; }

      const t  = activeTarget;
      const ok = chosen === t.question.correct;
      if (ok) { state.score += t.points; state.savedSeconds += remaining; }
      state.answered[t.id] = ok;
      state.closed[t.id]   = true;

      resultBox.style.display = "block";
      resultBox.className = `result ${ok ? "ok" : "bad"}`;
      resultBox.textContent =
        (ok ? `Spr√°vnƒõ! +${t.points} bod≈Ø. ` : "≈†patnƒõ. +0 bod≈Ø. ") +
        `Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;
      setTimeout(() => { closePanel(); saveState(); }, 2000);
    });

    btnClosePanel.addEventListener("click", closePanel);

    // ===== 9) GEOLOKACE =====
    function setStatus(t) { elStatus.textContent = t; }

    function startGeo() {
      if (!("geolocation" in navigator)) { setStatus("Geolokace nen√≠ podporov√°na."); return; }
      setStatus("Hled√°m polohu‚Ä¶");
      navigator.geolocation.watchPosition(pos => {
        lastFix = pos;
        const { latitude:la, longitude:lo, accuracy:ac } = pos.coords;
        elAcc.textContent = `${Math.round(ac)} m`;

        if (!userMarker) userMarker = L.marker([la,lo]).addTo(map).bindPopup("Ty");
        else userMarker.setLatLng([la,lo]);

        if (!accCircle) accCircle = L.circle([la,lo],{radius:ac,weight:1,color:"#94a3b8"}).addTo(map);
        else accCircle.setLatLng([la,lo]).setRadius(ac);

        const r = calcR(ac);

        // Aktualizuj z√≥nov√© kruhy v≈°ech bod≈Ø
        TARGETS.forEach(t => zoneMap[t.id].setRadius(r));

        // Pokud je panel otev≈ôen, nic dal≈°√≠ho ne≈ôe≈°√≠me
        if (panelOpen) return;

        // Zkontroluj vzd√°lenost ke ka≈æd√©mu neuzav≈ôen√©mu bodu
        const allClosed = TARGETS.every(t => state.closed[t.id]);
        if (allClosed) { setStatus("V≈°echny body splnƒõny! üéâ"); return; }

        let nearest = null, nearestDist = Infinity;
        for (const t of TARGETS) {
          if (state.closed[t.id]) continue;
          const d = dist(la, lo, t.lat, t.lng);
          if (d <= r) { openPanel(t); return; } // vstup do z√≥ny ‚Üí okam≈æitƒõ otev≈ôi
          if (d < nearestDist) { nearestDist = d; nearest = t; }
        }

        if (nearest) setStatus(`Nejbl√≠≈æ: ${nearest.name} ‚Äî ${Math.round(nearestDist)} m (tolerance ~${r} m)`);

      }, err => setStatus("GPS chyba: "+err.message),
         { enableHighAccuracy:true, maximumAge:1000, timeout:15000 });
    }

    // ===== 10) LEADERBOARD =====
    function loadLb() { try { return JSON.parse(localStorage.getItem(LS_LB))??[]; } catch { return []; } }
    function saveLb(a) { localStorage.setItem(LS_LB, JSON.stringify(a)); }

    function fmtDate(ts) {
      if (!ts) return "‚Äî";
      const d = new Date(ts);
      return `${d.getDate()}.${d.getMonth()+1}. ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function renderLb() {
      const entries = loadLb().sort((a,b) => (b.score - a.score) || (b.savedSeconds - a.savedSeconds));

      if (entries.length === 0) {
        lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">≈Ωeb≈ô√≠ƒçek je zat√≠m pr√°zdn√Ω.<br/>Dohraj hru a klikni ‚ÄûUlo≈æit bƒõh".</td></tr>`;
        return;
      }

      lbBody.innerHTML = entries.map((x, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${esc(x.nickname)}</td>
          <td><b>${x.score}</b></td>
          <td>${fmt(x.savedSeconds)}</td>
          <td style="color:#6b7280">${fmtDate(x.at)}</td>
        </tr>`).join("");
    }

    // P≈ô√≠znak: byl run ji≈æ v tomto sezen√≠ ulo≈æen?
    let runSaved = false;
    const btnSaveRun = document.getElementById("btnSaveRun");

    document.getElementById("btnLeaderboard").addEventListener("click", () => {
      drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); renderLb();
    });
    document.getElementById("btnCloseDrawer").addEventListener("click", () => {
      drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true");
    });

    btnSaveRun.addEventListener("click", () => {
      if (runSaved) return; // zabr√°n√≠ duplicit√°m
      ensureNick();
      if (!state.nickname || state.nickname.trim().length < 2) return; // overlay otev≈ôen, ƒçek√°me
      const a = loadLb();
      a.push({ nickname: state.nickname, score: state.score, savedSeconds: state.savedSeconds, at: Date.now() });
      saveLb(a);
      renderLb();
      runSaved = true;
      btnSaveRun.textContent = "‚úì Ulo≈æeno";
      btnSaveRun.disabled = true;
    });

    document.getElementById("btnClearLb").addEventListener("click", () => {
      if (confirm("Smazat ≈æeb≈ô√≠ƒçek?")) { saveLb([]); renderLb(); }
    });

    // ===== 11) OVL√ÅD√ÅN√ç =====
    document.getElementById("btnCenter").addEventListener("click", () => {
      if (lastFix) map.setView([lastFix.coords.latitude, lastFix.coords.longitude], 17);
      else map.setView([centerLat, centerLng], 15);
    });
    document.getElementById("btnReset").addEventListener("click", () => {
      if (!confirm("Resetovat prototyp?")) return;
      state.score = 0; state.savedSeconds = 0;
      TARGETS.forEach(t => { state.closed[t.id] = false; state.answered[t.id] = false; });
      if (panelOpen) closePanel();
      runSaved = false;
      btnSaveRun.textContent = "Ulo≈æit bƒõh";
      btnSaveRun.disabled = false;
      saveState(); alert("Reset hotov.");
    });

    // ===== 12) PWA =====
    if ("serviceWorker" in navigator)
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch {}
      });

    // ===== INIT =====
    ensureNick();
    renderStats();
    renderMarkerState();
    startGeo();
    saveState();
  </script>
</body>
</html>
