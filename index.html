<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanychov Hunt ‚Äì Prototype</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f172a;
    --muted:#94a3b8;
    --text:#e2e8f0;
    --accent:#38bdf8;
    --good:#22c55e;
    --bad:#ef4444;
    --warn:#fbbf24;
    --radius:16px;
    --shadow: 0 12px 40px rgba(0,0,0,.35);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
  }

  /* Layout */
  .app{
    position:fixed;
    inset:0;
    display:flex;
    flex-direction:column;
  }

  header{
    padding:12px 14px;
    background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.75));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(148,163,184,.18);
    display:flex;
    align-items:center;
    gap:10px;
    z-index: 30;

    /* ‚úÖ fix: na √∫zk√©m mobilu se header zalom√≠ do 2 ≈ô√°dk≈Ø */
    flex-wrap: wrap;
    row-gap: 8px;
  }

  header .title{
    font-weight:800;
    letter-spacing:.2px;
    display:flex;
    flex-direction:column;
    line-height:1.05;
    flex: 1 1 180px;
    min-width: 160px;
  }

  header .title small{
    font-weight:600;
    color:var(--muted);
    font-size:12px;
  }

  /* ‚úÖ spacer u≈æ nen√≠ pot≈ôeba (wrap layout ho nahrazuje) */
  header .spacer{ display:none; }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
    color:var(--text);
    font-size:13px;
    user-select:none;
    white-space:nowrap;
  }

  .pill b{ font-variant-numeric: tabular-nums; }

  .pill .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--accent);
    box-shadow:0 0 0 4px rgba(56,189,248,.18);
  }

  .pill.warn .dot{
    background:var(--warn);
    box-shadow:0 0 0 4px rgba(251,191,36,.18);
  }

  .pill.good .dot{
    background:var(--good);
    box-shadow:0 0 0 4px rgba(34,197,94,.18);
  }

  .pill.bad .dot{
    background:var(--bad);
    box-shadow:0 0 0 4px rgba(239,68,68,.18);
  }

  .btn{
    appearance:none;
    border:none;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(56,189,248,.16);
    color:var(--text);
    font-weight:700;
    cursor:pointer;
    border:1px solid rgba(56,189,248,.35);
    transition: transform .08s ease, background .15s ease;
    user-select:none;
  }

  .btn:active{ transform: scale(.98); }
  .btn.secondary{ background:rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.25); }
  .btn.danger{ background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }

  main{
    flex:1;
    position:relative;
  }

  #map{
    height:100%;
    width:100%;
  }

  /* ===== Leaflet layer fix ‚Äî a≈• mapa nikdy nep≈ôekryje modal ===== */
  .leaflet-pane,
  .leaflet-control,
  .leaflet-top,
  .leaflet-bottom{
    z-index: 10 !important;
  }

  .leaflet-popup{
    z-index: 20 !important;
  }

  /* ===== Always-visible labels for targets (Variant A) ===== */
  .hh-label{
    background: rgba(2,6,23,.75);
    border: 1px solid rgba(148,163,184,.25);
    color: #e2e8f0;
    padding: 6px 8px;
    border-radius: 10px;
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
    font-weight: 800;
    font-size: 12px;
    line-height: 1.15;
    white-space: nowrap;
    pointer-events: none;
  }
  .hh-label .muted{
    color: #94a3b8;
    font-weight: 700;
    font-size: 11px;
  }

  /* status banner */
  .status{
    position:absolute;
    left:12px;
    right:12px;
    bottom:12px;
    background:rgba(15,23,42,.90);
    border:1px solid rgba(148,163,184,.20);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow: var(--shadow);
    z-index: 25;
    backdrop-filter: blur(10px);
    cursor: default; /* click target nastavujeme jen kdy≈æ je pot≈ôeba */
  }

  .status .msg{
    flex:1;
    font-size:13px;
    color:var(--text);
  }

  .status .acc{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }

  /* Question panel (bottom sheet) */
  .panel{
    position:absolute;
    left:0;
    right:0;
    bottom:-100%;
    background: rgba(15,23,42,.96);
    border-top:1px solid rgba(148,163,184,.20);
    border-radius: 18px 18px 0 0;
    padding: 14px 14px 16px;
    box-shadow: var(--shadow);
    transition: bottom .22s ease;
    z-index: 100000; /* nad mapou + nad v≈°√≠m */
    max-height: 78%;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  .panel.open{ bottom:0; }
  .panel .row{ display:flex; align-items:center; gap:10px; }
  .panel h2{ margin:10px 0 6px; font-size:18px; }

  .badge{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
    color:var(--text);
    font-size:12px;
    font-weight:700;
    white-space:nowrap;
  }

  .timer{
    margin-left:auto;
    font-weight:800;
    font-variant-numeric: tabular-nums;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.45);
  }

  .timer.urgent{
    border-color: rgba(239,68,68,.55);
    color: #fecaca;
  }

  .qtext{
    color:var(--text);
    margin:10px 0 12px;
    font-size:14px;
    line-height:1.35;
  }

  .opts{ display:grid; gap:8px; }

  label.opt{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.38);
    cursor:pointer;
    transition: background .15s ease, border-color .15s ease, transform .08s ease;
    user-select:none;
  }

  label.opt:hover{ background: rgba(2,6,23,.50); }
  label.opt:active{ transform: scale(.99); }
  label.opt input{ margin-top:2px; }
  label.opt.selected{ border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.08); }

  .result{
    margin-top:12px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.38);
    font-size:13px;
    line-height:1.35;
    display:none;
  }

  .result.good{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.08); }
  .result.bad{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.08); }

  /* ‚úÖ Fact styling */
  .result.fact{
    border-color: rgba(148,163,184,.35);
    background: rgba(148,163,184,.06);
  }

  .panel .actions{
    display:flex;
    gap:10px;
    margin-top:12px;
  }

  .panel .actions .btn{ flex:1; }

  /* Modal backdrop */
  .modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 14px;
    z-index: 99999;
  }

  /* ‚úÖ HELP MODAL tweaks */
  #helpBackdrop{ display:none; }
  #helpBackdrop.show{ display:flex; }
  #helpModal{ max-height: 85vh; overflow:auto; }

  /* leaderboard */
  .lb{
    position:absolute;
    top:12px;
    right:12px;
    width:min(360px, calc(100vw - 24px));
    background:rgba(15,23,42,.90);
    border:1px solid rgba(148,163,184,.20);
    border-radius: 16px;
    box-shadow: var(--shadow);
    z-index: 25;
    overflow:hidden;
    display:none;
    backdrop-filter: blur(10px);
  }

  .lb header{
    position:static;
    border:none;
    background:transparent;
    padding:12px 12px 10px;
  }

  .lb header .title{ font-size:14px; }
  .lb header .title small{ font-size:11px; }
  .lb .content{ padding:0 12px 12px; }

  table{ width:100%; border-collapse:collapse; font-size:12px; }
  th,td{ padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.14); text-align:left; }
  th{ color:var(--muted); font-weight:800; }
  tr:last-child td{ border-bottom:none; }
  .lb .muted{ color:var(--muted); }
  .lb-empty{ padding:10px 0; color:var(--muted); }

  /* small screens */
  @media (max-width:480px){
    header{ gap:8px; }
    .btn{ padding:10px 10px; }
    .pill{ padding:8px 9px; }

    /* ‚úÖ na mobilu: pilly se ve druh√©m ≈ô√°dku hezky rozprost≈ôou */
    .pill{ flex: 1 1 auto; }
    #btnCenter, #btnLb, #btnReset{ flex: 0 0 auto; }

    /* ‚úÖ aby "ƒåas" ≈°el v≈ædy na cel√Ω druh√Ω ≈ô√°dek, kdy≈æ je pot≈ôeba */
    #pillSaved{ flex: 1 1 100%; }
  }

  /* ===== HEADER ‚Äî pevn√© rozlo≈æen√≠ po wrapu (po≈ôad√≠ prvk≈Ø) ===== */
  header .title{ order: 1; }

  #pillScore{
    order: 2;
    margin-left: auto;
  }

  #pillSaved{
    order: 3;
    flex: 1 1 auto;
  }

  .btncapsule{ order: 4; }

  /* ===== Button capsule (game UI) ===== */
  .btncapsule{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
  }

  .iconbtn{
    appearance:none;
    border:none;
    width:44px;
    height:44px;
    border-radius:14px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;

    background:rgba(148,163,184,.10);
    border:1px solid rgba(148,163,184,.25);
    color:var(--text);

    transition: transform .08s ease, background .15s ease;
  }
  .iconbtn:active{ transform: scale(.98); }

  .iconbtn:hover{
    background:rgba(148,163,184,.14);
  }

  .iconbtn.danger{
    background:rgba(239,68,68,.12);
    border:1px solid rgba(239,68,68,.35);
  }
</style>

</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Hanychov Hunt
        <small>prototyp ‚Äî geolokaƒçn√≠ hra</small>
      </div>
      <div class="spacer"></div>

      <div class="pill" id="pillScore" title="Sk√≥re">
        <span class="dot"></span>
        <span>Sk√≥re: <b id="score">0</b></span>
      </div>

      <div class="pill" id="pillSaved" title="Ulo≈æen√Ω ƒças">
        <span class="dot"></span>
        <span>ƒåas: <b id="saved">0</b>s</span>
      </div>

      <div class="btncapsule" role="group" aria-label="Ovl√°d√°n√≠">
        <button class="iconbtn" id="btnCenter" title="Centrovat na mƒõ" aria-label="Centrovat">üìç</button>
        <button class="iconbtn" id="btnLb" title="Leaderboard" aria-label="Leaderboard">üèÜ</button>
        <button class="iconbtn danger" id="btnReset" title="Reset" aria-label="Reset">‚ü≤</button>
      </div>
    </header>

    <main>
      <div id="map"></div>

      <div class="status" id="statusBar">
        <div class="msg" id="statusMsg">Naƒç√≠t√°m‚Ä¶</div>
        <div class="acc">P≈ôesnost: <span id="accVal">‚Äî</span></div>
      </div>

      <div class="panel" id="questionPanel" aria-modal="true" role="dialog">
        <div class="row">
          <span class="badge" id="pointNameBadge">Bod</span>
          <span class="badge" id="pointsBadge">0 bod≈Ø</span>
          <span class="timer" id="timer">03:00</span>
        </div>
        <h2>Ot√°zka</h2>
        <div class="qtext" id="questionText">‚Ä¶</div>

        <div class="opts">
          <label class="opt"><input type="radio" name="ans" value="a"><span><b>A)</b> <span id="optA">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="b"><span><b>B)</b> <span id="optB">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="c"><span><b>C)</b> <span id="optC">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="d"><span><b>D)</b> <span id="optD">‚Ä¶</span></span></label>
        </div>

        <div class="result" id="resultBox"></div>
        <!-- ‚úÖ Zaj√≠mavost po vyhodnocen√≠ -->
        <div class="result fact" id="factBox"></div>

        <div class="actions">
          <button class="btn" id="btnSubmit">Odeslat</button>
          <button class="btn secondary" id="btnClose">Zav≈ô√≠t</button>
        </div>

        <div style="margin-top:10px; color:var(--muted); font-size:11px;">
          Tip: Geolokace funguje na <b>https</b> nebo <b>localhost</b>.
        </div>
      </div>

      <div class="lb" id="lbBox">
        <header>
          <div class="title">
            Leaderboard
            <small>Top v√Ωsledky</small>
          </div>
          <div class="spacer"></div>
          <button class="btn secondary" id="btnLbClose">Zav≈ô√≠t</button>
        </header>
        <div class="content">
          <div class="muted" style="font-size:11px; margin-bottom:8px;">
            Sk√≥re = body. Ulo≈æen√Ω ƒças = zbyl√© sekundy ze spr√°vn√Ωch odpovƒõd√≠.
          </div>
          <table>
            <thead>
              <tr>
                <th>#</th><th>Nick</th><th>Sk√≥re</th><th>ƒåas</th><th>Datum</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="5" class="lb-empty">Naƒç√≠t√°m‚Ä¶</td></tr>
            </tbody>
          </table>

          <div style="display:flex; gap:10px; margin-top:10px;">
            <input id="nick" placeholder="Tvoje p≈ôezd√≠vka" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.22); background:rgba(2,6,23,.35); color:var(--text); outline:none;">
            <button class="btn" id="btnSaveRun">Ulo≈æit bƒõh</button>
          </div>
          <div class="muted" style="font-size:11px; margin-top:8px;">
            Pozn.: Bavte se!
          </div>
        </div>
      </div>

      <!-- ===== HELP / N√ÅVOD MODAL ===== -->
      <div class="modal-backdrop" id="helpBackdrop">
        <div class="panel" id="helpModal" style="position:relative; max-width:720px; width:min(720px, 100%); border-radius:18px; bottom:auto;">
          <div class="row" style="align-items:flex-start;">
            <span class="badge">N√°vod</span>
            <div style="flex:1"></div>
            <button class="btn secondary" id="btnHelpClose" title="Zav≈ô√≠t">‚úï</button>
          </div>

          <h2 style="margin-top:10px;">Jak hr√°t</h2>

          <div class="qtext" style="margin-top:8px;">
            <ol style="margin:0; padding-left:18px; line-height:1.5;">
              <li><b>Povol GPS</b> (poloha funguje jen na <b>HTTPS</b> nebo <b>localhost</b>).</li>
              <li>Na mapƒõ vid√≠≈° <b>kontroln√≠ body</b>. P≈ôijdi k bodu co nejbl√≠≈æ.</li>
              <li>Jakmile bude≈° v dosahu (tolerance se ≈ô√≠d√≠ p≈ôesnost√≠ GPS), otev≈ôe se <b>ot√°zka</b>.</li>
              <li>M√°≈° <b>3 minuty</b>. Za spr√°vnou odpovƒõƒè z√≠sk√°≈° <b>body</b> a ulo≈æ√≠ se ti zbyl√Ω ƒças.</li>
              <li>Spl≈à v≈°echny body a m≈Ø≈æe≈° si ulo≈æit sk√≥ra a ƒças do <b>leaderboardu</b>.</li>
            </ol>

            <div style="margin-top:10px; color:var(--muted); font-size:12px;">
              Tip: kdy≈æ se GPS ‚Äûsekne‚Äú, klepni na status li≈°tu dole (nap≈ô. ‚ÄûGPS nereaguje‚Äú) a hra GPS restartuje.
            </div>
          </div>

          <label style="display:flex; gap:10px; align-items:center; margin-top:12px; color:var(--muted); font-size:12px; user-select:none;">
            <input type="checkbox" id="helpDontShow" />
            P≈ô√≠≈°tƒõ u≈æ nezobrazovat
          </label>

          <div class="actions" style="margin-top:12px;">
            <button class="btn" id="btnHelpStart">Rozum√≠m, jdeme hr√°t</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // ===== 0) DATA =====
    // ‚úÖ P≈ôidej ke ka≈æd√©mu bodu volitelnƒõ: fact: "zaj√≠mavost..."
    const TARGETS = [
      { id:"hasicarna", name:"SDH HH", points: 125, lat: 50.7399112, lng: 15.0185144,
        question:{ text:"V jak√©m roce byl zalo≈æen m√≠stn√≠ sbor dobrovoln√Ωch hasiƒç≈Ø?", options:{a:"1889",b:"1901",c:"1903",d:"1905"}, correct:"b"},
        fact:"Sbor dobrovoln√Ωch hasiƒç≈Ø v Horn√≠m Hanychovƒõ pat≈ô√≠ mezi nejmlad≈°√≠ hasiƒçsk√© sbory v Liberci a jeho historie sah√° do roku 1901. Dobrovoln√≠ hasiƒçi tu tradiƒçnƒõ nejsou jen ‚Äûu z√°sah≈Ø‚Äú, ale i u komunitn√≠ch akc√≠ a ≈æivota ƒçtvrti." },

      { id:"kostel", name:"Kostel Sv. Bonif√°ce", points: 200, lat: 50.7415237, lng: 15.0208265, 
       question:{ text:"Kolik dve≈ô√≠ vede do kostela?", options:{a:"2",b:"3",c:"4",d:"5"}, correct:"d"},
      fact:"Svat√Ω Bonif√°c, patron kostela, byl anglick√Ω mision√°≈ô z 8. stolet√≠ zvan√Ω ¬¥apo≈°tol Nƒõmc≈Ø¬¥, kter√Ω ≈°√≠≈ôil k≈ôes≈•anstv√≠ ve st≈ôedn√≠ Evropƒõ a podle legendy pok√°cel posv√°tn√Ω dub boha Th√≥ra jako symbol v√≠tƒõzstv√≠ nov√© v√≠ry nad pohanstv√≠m. Hanychov≈°t√≠ p≈Øvodnƒõ p≈ô√≠slu≈°eli a≈æ ke kostelu sv. Jana K≈ôtitele v Rochlici, a tak roku 1896 zalo≈æili chr√°mov√Ω spolek, kter√Ω usiloval o postaven√≠ kostela vlastn√≠ho. Stavba podle projektu architekta A. M√∂llera zapoƒçala roku 1915, ale kv≈Øli hospod√°≈ôsk√Ωm probl√©m≈Øm v 1. sv. v√°lce se prot√°hla a≈æ do roku 1919. Proto≈æe byl kostel urƒçen pro nƒõmeck√© obyvatelstvo Hanychova, byl zasvƒõcen pr√°vƒõ sv. Bonif√°ci. Po odsunu Nƒõmc≈Ø v roce 1945, zaƒçal kostel ch√°trat a hrozila mu i demolice. Teprve na p≈ôelomu 20. a 21. stolet√≠ se doƒçkal oprav a dnes je vyu≈æ√≠van√Ω nejen k bohoslu≈æb√°m, ale t≈ôeba i koncert≈Øm." },
    
      { id:"spaleniste", name:"Sp√°leni≈°tƒõ", points: 100, lat: 50.7402846, lng: 15.0169694,
        question:{ text:"Kdy vyho≈ôela slavn√° restaurace Zum Wallhalle?", options:{a:"1918",b:"1939",c:"1942",d:"1948"}, correct:"c"},
        fact:"Restaurace Zur Walhalla byla obl√≠ben√Ωm v√Ωletn√≠m hostincem na Sp√°leni≈°ti p≈ôed 2. svƒõtovou v√°lkou. Vyho≈ôela 8. listopadu 1942 kv≈Øli p≈ôetopen√Ωm kamen≈Øm ‚Äì odtud n√°zev zast√°vky, kter√Ω p≈ôipom√≠n√° tuto trag√©dii." },

      { id:"lanovka", name:"Lanovka", points: 300, lat: 50.7354826, lng: 15.0010897,
        question:{ text:"Kolik mƒõs√≠c≈Ø trvala stavba p≈Øvodn√≠ lanovky?", options:{a:"9",b:"12",c:"15",d:"18"}, correct:"b"},
        fact:"Nƒõmeck√Ω horsk√Ω spolek pro Je≈°tƒõd a Jizersk√© hory se u≈æ roku 1924 sna≈æil z√≠skat povolen√≠ ke stavbƒõ visut√© lanovky na vrchol hory k hotelu, kter√Ω tenkr√°t vlastnil. Nakonec v≈°ak lanovku vystavƒõly a≈æ ƒåeskoslovensk√© st√°tn√≠ dr√°hy roku 1933. P≈Øvodn√≠ lanovka z roku 1933 spojovala Horn√≠ Hanychov s Je≈°tƒõdem dokonce jen za 4 minuty. Po tragick√© nehodƒõ v roce 2025 je mimo provoz ‚Äì mƒõsto p≈ôipravuje novou kr√°snou lanovku." },

      { id:"surprise", name:"Kontroln√≠ bod", points: 111, lat: 50.7398127, lng: 15.0089711,
        question:{ text:"M√°≈° se dob≈ôe?", options:{a:"ano",b:"ne",c:"nev√≠m",d:"netu≈°√≠m"}, correct:"a"},
        fact:"Kr√°tk√° pauza je taky strategie: v ter√©nn√≠ch hr√°ch ƒçasto vyhr√°v√° ten, kdo si hl√≠d√° tempo a energii." },

      { id:"horska", name:"Horsk√° slu≈æba", points: 750, lat: 50.7351412, lng: 15.0007528,  
        question:{ text:"Jak√° barva nen√≠ na znaku Horsk√© slu≈æby?", options:{a:"zelen√°",b:"modr√°",c:"b√≠l√°",d:"ƒçerven√°"}, correct:"a"},
        fact:"Na Je≈°tƒõdu pom√°h√° lidem v nouzi Horsk√° slu≈æba Jizersk√Ωch hor od roku 1954 ‚Äì prvn√≠ stanice ‚ÄûHS Jizerek‚Äú vznikla na Je≈°tƒõdsk√Ωch pl√°n√≠ch kv≈Øli ly≈æa≈ôsk√©mu vleku, kde bylo t≈ôeba o≈°et≈ôovat √∫razy ze sjezdovky. V Chatƒõ na Pl√°n√≠ch je dnes zaj√≠mav√© minimuzeum horsk√© slu≈æby, kter√© je vƒõnovan√© nelehk√Ωm zaƒç√°tk≈Øm t√©to profese." },
      
      { id:"brana", name:"Socha", points: 100, lat: 50.7380168, lng: 15.0118893,  
        question:{ text:"Jak√Ω je n√°zev sochy od Laca Sorok√°ƒçe u skiare√°lu?", options:{a:"Br√°na ly≈æa≈ô≈Ø",b:"Srdce Je≈°tƒõdu",c:"Br√°na borc≈Ø",d:"C√≠l m≈Østk≈Ø"}, correct:"c"},
        fact:"Br√°na borc≈Ø je abstraktn√≠ socha z roku 2008 p≈ôedstavuj√≠c√≠ ly≈æa≈ôe jako c√≠lovou br√°nu. Vznikla pro Sculpture Forum a dnes v√≠t√° n√°v≈°tƒõvn√≠ky Je≈°tƒõdu jako symbol sportu a umƒõn√≠." },

       { id:"tram", name:"Tramvajov√° tra≈•", points: 100, lat: 50.7381560, lng: 15.0124311,
        question:{ text:"Jak√° linka jezd√≠ od ZOO a≈æ sem?", options:{a:"1",b:"2",c:"3",d:"4"}, correct:"c"},
        fact:"U≈æ je to v√≠c ne≈æ cel√© stolet√≠, kdy se po kolej√≠ch rozjely tramvaje a≈æ do Horn√≠ho Hanychova (rok 1912). Obousmƒõrn√© vozy nahradily v roce 1960 tramvaje jednosmƒõrn√© a tra≈• samoz≈ôejmƒõ bƒõhem let pro≈°la i r≈Øzn√Ωmi √∫pravami. Nƒõkolikr√°t se dokonce zva≈æovalo prodlou≈æen√≠ tratƒõ a≈æ k doln√≠ stanici kabinov√© lanovky, ale k realizaci nikdy nedo≈°lo. Na koneƒçnou zast√°vku MHD dnes jezd√≠ linka ƒç. 3 a m√≠sto je nejv√Ω≈°e polo≈æenou tramvajovou zast√°vkou v ƒåR (522 m n. m.)." }

    ];

    // ===== 1) HELPERS =====
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const fmt = (s)=> {
      const m = Math.floor(s/60);
      const r = s%60;
      return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
    };
    function dist(lat1, lon1, lat2, lon2){
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function calcR(ac) { return !ac||!isFinite(ac)?25:clamp(Math.round(ac*1.2),18,50); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== 2) STATE =====
    const LS_STATE = "hh_state_v1";
    const LS_LB    = "hh_lb_v1";
    let state = {
      score: 0,
      savedSeconds: 0,
      closed: {},
      answered: {}
    };
    let runSaved = false;

    function ensureTargetDefaults(){
      if (!state || typeof state !== "object") state = { score:0, savedSeconds:0, closed:{}, answered:{} };
      if (typeof state.score !== "number") state.score = 0;
      if (typeof state.savedSeconds !== "number") state.savedSeconds = 0;
      if (!state.closed || typeof state.closed !== "object") state.closed = {};
      if (!state.answered || typeof state.answered !== "object") state.answered = {};
      TARGETS.forEach(t=>{
        if (state.closed[t.id] === undefined) state.closed[t.id] = false;
        if (state.answered[t.id] === undefined) state.answered[t.id] = false;
      });
    }

    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem(LS_STATE));
        if (s && typeof s === "object") state = s;
      } catch(e){}
      ensureTargetDefaults();
    }
    function saveState(){
      localStorage.setItem(LS_STATE, JSON.stringify(state));
      updateHeader();
      updateMarkers();
    }

    function resetAll(){
      if(!confirm("Opravdu resetovat postup?")) return;
      state = { score:0, savedSeconds:0, closed:{}, answered:{} };
      ensureTargetDefaults();
      if (questionOpen) closeModal({ reason:"system", cooldown:false });
      closeLb();
      closeHelp();
      runSaved = false;
      document.getElementById("btnSaveRun").textContent = "Ulo≈æit sk√≥re a ƒças";
      document.getElementById("btnSaveRun").disabled = false;
      saveState();
      setStatus("Reset hotov.");
      statusErrorOff();
    }

    // ===== 3) UI refs =====
    const elScore = document.getElementById("score");
    const elSaved = document.getElementById("saved");
    const statusBar = document.getElementById("statusBar");
    const elStatus = document.getElementById("statusMsg");
    const elAcc = document.getElementById("accVal");

    const btnCenter = document.getElementById("btnCenter");
    const btnReset = document.getElementById("btnReset");
    const btnLb = document.getElementById("btnLb");

    const questionPanel = document.getElementById("questionPanel");
    const pointNameBadge = document.getElementById("pointNameBadge");
    const pointsBadge = document.getElementById("pointsBadge");
    const questionText = document.getElementById("questionText");
    const optA = document.getElementById("optA");
    const optB = document.getElementById("optB");
    const optC = document.getElementById("optC");
    const optD = document.getElementById("optD");
    const elTimer = document.getElementById("timer");
    const resultBox = document.getElementById("resultBox");
    const factBox = document.getElementById("factBox");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnClose = document.getElementById("btnClose");

    // leaderboard
    const lbBox = document.getElementById("lbBox");
    const lbBody = document.getElementById("lbBody");
    const btnLbClose = document.getElementById("btnLbClose");
    const nickInput = document.getElementById("nick");
    const btnSaveRun = document.getElementById("btnSaveRun");

    function updateHeader(){
      elScore.textContent = state.score;
      elSaved.textContent = state.savedSeconds;
      const pillScore = document.getElementById("pillScore");
      const pillSaved = document.getElementById("pillSaved");
      pillScore.classList.toggle("good", state.score>0);
      pillSaved.classList.toggle("good", state.savedSeconds>0);
    }

    // ===== 4) MAP =====
    let map = L.map("map", { zoomControl:true }).setView([TARGETS[0].lat, TARGETS[0].lng], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const zoneMap = {};
    const markerMap = {};

    TARGETS.forEach(t=>{
      const m = L.circleMarker([t.lat,t.lng],{
        radius:10, weight:2, color:"#38bdf8", fillColor:"#38bdf8", fillOpacity:.25
      }).addTo(map);

      m.bindPopup(`<b>${escapeHtml(t.name)}</b><br>${t.points} bod≈Ø`);

      // ‚úÖ always-visible label (Variant A)
      m.bindTooltip(
        `<div class="hh-label">
           ${escapeHtml(t.name)}<br>
           <span class="muted">${t.points} bod≈Ø</span>
         </div>`,
        { permanent:true, direction:"top", offset:[0,-10], opacity:1, interactive:false }
      );

      markerMap[t.id]=m;

      const z = L.circle([t.lat,t.lng],{
        radius: 25, weight:1, color:"#94a3b8", fillColor:"#94a3b8", fillOpacity:.08
      }).addTo(map);
      zoneMap[t.id]=z;
    });

    let userMarker = null;
    let accCircle  = null;
    let lastFix = null;

    function updateMarkers(){
      TARGETS.forEach(t=>{
        const done = !!state.closed[t.id];
        const ok = !!state.answered[t.id];
        const m = markerMap[t.id];
        if(done){
          m.setStyle({
            color: ok ? "#22c55e" : "#ef4444",
            fillColor: ok ? "#22c55e" : "#ef4444",
            fillOpacity:.35
          });
        } else {
          m.setStyle({ color:"#38bdf8", fillColor:"#38bdf8", fillOpacity:.25 });
        }
      });
    }

    function invalidateMap(){
      setTimeout(()=>map.invalidateSize(), 120);
    }

    btnCenter.addEventListener("click", ()=>{
      if(lastFix){
        map.setView([lastFix.coords.latitude, lastFix.coords.longitude], 17, {animate:true});
      } else {
        map.fitBounds(L.latLngBounds(TARGETS.map(t=>[t.lat,t.lng])).pad(0.2));
      }
    });

    btnReset.addEventListener("click", resetAll);

    // ===== 5) QUESTION FLOW =====
    let timerInt = null, remaining = 180, questionOpen = false, activeTarget = null;
    let questionCooldownUntil = 0;
    const QUESTION_COOLDOWN_MS = 6000;

    // ‚úÖ stav: po vyhodnocen√≠ ƒçek√°me na ‚ÄûPokraƒçovat‚Äú
    let awaitingContinue = false;

    document.querySelectorAll('input[name="ans"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        document.querySelectorAll(".opt").forEach(l=>l.classList.remove("selected"));
        r.closest(".opt").classList.add("selected");
      });
    });

    function openQuestion(target) {
      if (questionOpen || state.closed[target.id]) return;

      closeLb();
      closeHelp();
      try { map.closePopup(); } catch(e){}

      activeTarget = target;
      questionOpen = true;
      remaining = 180;
      awaitingContinue = false;

      resultBox.style.display = "none";
      resultBox.className = "result";

      factBox.style.display = "none";
      factBox.className = "result fact";
      factBox.textContent = "";

      btnSubmit.disabled = false;
      btnSubmit.textContent = "Odeslat";

      btnClose.textContent = "Zav≈ô√≠t";

      document.querySelectorAll('input[name="ans"]').forEach(r => r.checked = false);
      document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));

      pointNameBadge.textContent = target.name;
      pointsBadge.textContent    = `${target.points} bod≈Ø`;
      questionText.textContent   = target.question.text;
      optA.textContent = target.question.options.a;
      optB.textContent = target.question.options.b;
      optC.textContent = target.question.options.c;
      optD.textContent = target.question.options.d;

      elTimer.textContent = "03:00";
      elTimer.classList.remove("urgent");

      questionPanel.classList.add("open");
      invalidateMap();

      timerInt = setInterval(() => {
        remaining--;
        elTimer.textContent = fmt(remaining);
        if (remaining <= 30) elTimer.classList.add("urgent");
        if (remaining <= 0) closeAsTimeout();
      }, 1000);
    }

    function closeModal({reason="manual", cooldown=true} = {}) {
      if (cooldown && reason === "manual") {
        questionCooldownUntil = Date.now() + QUESTION_COOLDOWN_MS;
      }

      questionPanel.classList.remove("open");
      questionOpen = false;
      activeTarget = null;
      awaitingContinue = false;
      elTimer.classList.remove("urgent");

      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      invalidateMap();
    }

    function showFactIfAny(t){
      const fact = (t && t.fact) ? String(t.fact) : "";
      if (!fact.trim()) {
        factBox.style.display = "none";
        return;
      }
      factBox.style.display = "block";
      factBox.className = "result fact";
      // textContent = safe (≈æ√°dn√© HTML)
      factBox.textContent = "Zaj√≠mavost: " + fact.trim();
    }

    function finalizeAndWaitForContinue(t){
      // po vyhodnocen√≠ se UI p≈ôepne do re≈æimu ‚ÄûPokraƒçovat‚Äú
      awaitingContinue = true;
      btnSubmit.disabled = true;
      btnClose.textContent = "Pokraƒçovat";
      showFactIfAny(t);
      // hned ulo≈æ√≠me, aby se zmƒõny projevily na mapƒõ/score i p≈ôi ƒçten√≠ zaj√≠mavosti
      saveState();
      maybeStopGpsIfDone();
    }

    function closeAsTimeout() {
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      const t = activeTarget;
      if (!t) return;

      state.closed[t.id] = true;
      state.answered[t.id] = false;

      resultBox.style.display = "block";
      resultBox.className = "result bad";
      resultBox.textContent = `ƒåas vypr≈°el. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;

      finalizeAndWaitForContinue(t);
    }

    btnSubmit.addEventListener("click", () => {
      if (btnSubmit.disabled || !activeTarget) return;
      const chosen = document.querySelector('input[name="ans"]:checked')?.value;
      if (!chosen) { alert("Vyber jednu odpovƒõƒè."); return; }

      if (timerInt) { clearInterval(timerInt); timerInt = null; }

      const t = activeTarget, ok = chosen === t.question.correct;
      if (ok) { state.score += t.points; state.savedSeconds += remaining; }

      state.answered[t.id] = ok;
      state.closed[t.id]   = true;

      resultBox.style.display = "block";
      resultBox.className = `result ${ok ? "good":"bad"}`;
      resultBox.textContent = ok
        ? `Spr√°vnƒõ! +${t.points} bod≈Ø a +${remaining}s ulo≈æen√©ho ƒçasu.`
        : `≈†patnƒõ. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;

      finalizeAndWaitForContinue(t);
    });

    btnClose.addEventListener("click", () => {
      if (awaitingContinue) {
        // po vyhodnocen√≠: zav≈ôi a dej cooldown (a≈• se hned znovu neotev≈ôe p≈ôi st√°n√≠ v z√≥nƒõ)
        closeModal({reason:"manual", cooldown:true});
      } else {
        // p≈ôed vyhodnocen√≠m: norm√°ln√≠ zav≈ôen√≠
        closeModal({reason:"manual", cooldown:true});
      }
    });

    // ===== 10) GEOLOKACE =====
    function setStatus(t) { elStatus.textContent = t; }

    function statusErrorOn() {
      if (!statusBar) return;
      statusBar.style.borderColor = "#ef4444";
      statusBar.style.boxShadow = "0 0 0 2px rgba(239,68,68,.35)";
    }

    function statusErrorOff() {
      if (!statusBar) return;
      statusBar.style.borderColor = "";
      statusBar.style.boxShadow = "";
    }

    function setStatusClickable(enabled, handler){
      if (!statusBar) return;
      if (enabled) {
        statusBar.style.cursor = "pointer";
        statusBar.onclick = handler;
      } else {
        statusBar.style.cursor = "default";
        statusBar.onclick = null;
      }
    }

    let gpsWatchdogTimer = null, gpsWatchId = null, gpsFirstFix = false;
    let lastFixAt = 0;

    function resetGpsWatchdog() {
      if (gpsWatchdogTimer) clearTimeout(gpsWatchdogTimer);

      gpsWatchdogTimer = setTimeout(() => {
        const age = lastFixAt ? (Date.now() - lastFixAt) : Infinity;

        if (gpsFirstFix && age < 30000) {
          resetGpsWatchdog();
          return;
        }

        statusErrorOn();
        setStatus(gpsFirstFix
          ? "‚ö†Ô∏è GPS chv√≠li neaktualizuje ‚Äî klepni sem pro obnoven√≠"
          : "‚è≥ ƒåek√°m na GPS‚Ä¶ trv√° to d√©le ‚Äî klepni sem pro obnoven√≠"
        );
        setStatusClickable(true, restartGps);
      }, 20000);
    }

    function stopWatching(){
      if (gpsWatchId !== null) {
        try { navigator.geolocation.clearWatch(gpsWatchId); } catch(e){}
        gpsWatchId = null;
      }
      if (gpsWatchdogTimer) { clearTimeout(gpsWatchdogTimer); gpsWatchdogTimer = null; }
      setStatusClickable(false, null);
    }

    function maybeStopGpsIfDone(){
      if (TARGETS.every(t => !!state.closed[t.id])) {
        setStatus("V≈°echny body splnƒõny! üéâ (GPS vypnuta)");
        statusErrorOff();
        stopWatching();
      }
    }

    function restartGps() {
      stopWatching();
      gpsFirstFix = false;
      lastFixAt = 0;
      statusErrorOff();
      setStatus("Obnovuji GPS‚Ä¶");
      setStatusClickable(true, restartGps);
      resetGpsWatchdog();
      setTimeout(startWatching, 500);
    }

    function startWatching() {
      if (!("geolocation" in navigator)) {
        statusErrorOn();
        setStatus("Geolokace nen√≠ podporov√°na.");
        setStatusClickable(false, null);
        return;
      }

      gpsWatchId = navigator.geolocation.watchPosition(pos => {
        lastFix = pos;
        lastFixAt = Date.now();

        if (!gpsFirstFix) {
          gpsFirstFix = true;
          statusErrorOff();
          setStatus("üìç GPS nalezena ‚Äî hled√°m body‚Ä¶");
        }

        resetGpsWatchdog();
        setStatusClickable(false, null);
        statusErrorOff();

        const { latitude:la, longitude:lo, accuracy:ac } = pos.coords;
        elAcc.textContent = `${Math.round(ac)} m`;

        if (!userMarker) userMarker = L.marker([la,lo]).addTo(map).bindPopup("Ty");
        else userMarker.setLatLng([la,lo]);

        if (!accCircle) accCircle = L.circle([la,lo],{radius:ac,weight:1,color:"#94a3b8"}).addTo(map);
        else accCircle.setLatLng([la,lo]).setRadius(ac);

        const r = calcR(ac);
        TARGETS.forEach(t => zoneMap[t.id].setRadius(r));

        if (TARGETS.every(t => !!state.closed[t.id])) {
          maybeStopGpsIfDone();
          return;
        }

        if (questionOpen) return;
        if (Date.now() < questionCooldownUntil) return;

        let nearest = null, nearestDist = Infinity;
        let inRangeNearest = null, inRangeDist = Infinity;

        for (const t of TARGETS) {
          if (state.closed[t.id]) continue;
          const d = dist(la, lo, t.lat, t.lng);

          if (d < nearestDist) { nearestDist = d; nearest = t; }
          if (d <= r && d < inRangeDist) { inRangeDist = d; inRangeNearest = t; }
        }

        if (inRangeNearest) {
          openQuestion(inRangeNearest);
          return;
        }

        if (nearest) setStatus(`Nejbl√≠≈æ: ${nearest.name} ‚Äî ${Math.round(nearestDist)} m (tolerance ~${r} m)`);

      }, err => {
        if (err.code === 3 && gpsFirstFix) return;

        statusErrorOn();

        if (err.code === 1) setStatus("‚ö†Ô∏è Povolen√≠ GPS zam√≠tnuto ‚Äî povol polohu v nastaven√≠ prohl√≠≈æeƒçe.");
        else if (err.code === 2) setStatus("‚ö†Ô∏è GPS sign√°l nedostupn√Ω ‚Äî zkus j√≠t ven nebo zapnout/vypnout GPS.");
        else setStatus(gpsFirstFix ? "‚ö†Ô∏è GPS timeout ‚Äî klepni pro restart" : "‚è≥ ƒåek√°m na GPS‚Ä¶ trv√° to d√©le ‚Äî klepni pro restart");

        setStatusClickable(true, restartGps);
        resetGpsWatchdog();
      },
      { enableHighAccuracy: true, maximumAge: 3000, timeout: 20000 });
    }

    function startGeo() {
      if (!("geolocation" in navigator)) {
        statusErrorOn();
        setStatus("Geolokace nen√≠ podporov√°na.");
        return;
      }
      setStatus("Hled√°m polohu‚Ä¶");
      statusErrorOff();
      setStatusClickable(true, restartGps);
      resetGpsWatchdog();
      startWatching();
    }

   // ===== 11) LEADERBOARD =====
const SUPABASE_URL = "https://tdsyqaxkeipcxkrlqnnx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkc3lxYXhrZWlwY3hrcmxxbm54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MzMxMzgsImV4cCI6MjA4NzUwOTEzOH0.HHQren3L0yzXzqyryJlDzYdKb7WkyrtGm24zHJ8b8IA";
let sb = null, sbReady = false;

async function initSupabase(){
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
  try{
    const mod = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
    sb = mod.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    sbReady = true;
  }catch(e){
    console.warn("Supabase init failed", e);
  }
}

function loadLbLocal() { try { return JSON.parse(localStorage.getItem(LS_LB)) ?? []; } catch { return []; } }
function saveLbLocal(a) { localStorage.setItem(LS_LB, JSON.stringify(a)); }

async function renderLb() {
  lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Naƒç√≠t√°m‚Ä¶</td></tr>`;

  // 1) Prim√°rnƒõ: Supabase (sd√≠len√© pro v≈°echny)
  if (sb && sbReady) {
    try {
      const { data, error } = await sb.from("leaderboard")
        .select("nickname,score,saved_seconds,created_at")
        .order("score", { ascending: false })
        .order("saved_seconds", { ascending: false })
        .order("created_at", { ascending: true })
        .limit(20);

      if (error) throw error;

      const rows = (data || []);
      if (!rows.length) {
        lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Zat√≠m ≈æ√°dn√© ulo≈æen√© bƒõhy.</td></tr>`;
        return;
      }

      lbBody.innerHTML = rows.map((x,i)=>{
        const d = x.created_at ? new Date(x.created_at) : null;
        const dateStr = d ? d.toLocaleDateString("cs-CZ") : "‚Äî";
        const nick = escapeHtml((x.nickname || "‚Äî").slice(0,16));
        const score = Number(x.score ?? 0);
        const saved = Number(x.saved_seconds ?? 0);
        return `<tr>
          <td>${i+1}</td>
          <td>${nick}</td>
          <td><b>${score}</b></td>
          <td>${saved}s</td>
          <td>${escapeHtml(dateStr)}</td>
        </tr>`;
      }).join("");

      return;
    } catch (e) {
      console.warn("LB fetch failed (Supabase), falling back to local.", e);
      // pokud Supabase sel≈æe, uk√°≈æeme local fallback
    }
  }

  // 2) Fallback: local-only (offline / bez kl√≠ƒç≈Ø)
  const local = loadLbLocal()
    .sort((a,b)=> b.score - a.score || b.saved_seconds - a.saved_seconds)
    .slice(0,20);

  if (!local.length) {
    lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Zat√≠m ≈æ√°dn√© ulo≈æen√© bƒõhy (offline).</td></tr>`;
    return;
  }

  lbBody.innerHTML = local.map((x,i)=>{
    const d = x.created_at ? new Date(x.created_at) : null;
    const dateStr = d ? d.toLocaleDateString("cs-CZ") : "‚Äî";
    const nick = escapeHtml((x.nickname || "‚Äî").slice(0,16));
    const score = Number(x.score ?? 0);
    const saved = Number(x.saved_seconds ?? 0);
    return `<tr>
      <td>${i+1}</td>
      <td>${nick}</td>
      <td><b>${score}</b></td>
      <td>${saved}s</td>
      <td>${escapeHtml(dateStr)}</td>
    </tr>`;
  }).join("");
}

function openLb(){
  if (questionOpen) closeModal({reason:"system", cooldown:false});
  closeHelp();
  try { map.closePopup(); } catch(e){}

  lbBox.style.display = "block";
  renderLb();
  invalidateMap();
}

function closeLb(){
  lbBox.style.display = "none";
  invalidateMap();
}

btnLb.addEventListener("click", ()=> lbBox.style.display==="block" ? closeLb() : openLb() );
btnLbClose.addEventListener("click", closeLb);

btnSaveRun.addEventListener("click", async ()=> {
  if (runSaved) return;

  const nick = (nickInput.value || "").trim() || "Anonym";
  const entry = {
    nickname: nick,
    score: Math.max(0, Math.floor(state.score || 0)),
    saved_seconds: Math.max(0, Math.floor(state.savedSeconds || 0)),
    created_at: new Date().toISOString()
  };

  // Prim√°rnƒõ: Supabase (sd√≠len√© pro v≈°echny)
  if (sb && sbReady) {
    try {
      const { error } = await sb.from("leaderboard").insert({
        nickname: entry.nickname,
        score: entry.score,
        saved_seconds: entry.saved_seconds
      });
      if (error) throw error;

      runSaved = true;
      btnSaveRun.textContent = "Ulo≈æeno ‚úÖ";
      btnSaveRun.disabled = true;

      await renderLb();
      return;
    } catch (e) {
      console.warn("Supabase insert failed, falling back to local.", e);
      // fallback n√≠≈æe
    }
  }

  // Fallback: local-only (offline / bez kl√≠ƒç≈Ø)
  const local = loadLbLocal();
  local.push(entry);
  saveLbLocal(local);

  runSaved = true;
  btnSaveRun.textContent = "Ulo≈æeno (offline) ‚úÖ";
  btnSaveRun.disabled = true;

  await renderLb();
});

    // ===== HELP / N√ÅVOD =====
    const LS_HELP = "hh_help_v1";
    const helpBackdrop = document.getElementById("helpBackdrop");
    const btnHelpClose  = document.getElementById("btnHelpClose");
    const btnHelpStart  = document.getElementById("btnHelpStart");
    const helpDontShow  = document.getElementById("helpDontShow");

    function openHelp() {
      if (questionOpen) closeModal({reason:"system", cooldown:false});
      closeLb();
      try { map.closePopup(); } catch(e) {}

      helpBackdrop.classList.add("show");
      document.body.style.overflow = "hidden";
      invalidateMap();
    }

    function closeHelp() {
      helpBackdrop.classList.remove("show");
      document.body.style.overflow = "hidden";
      invalidateMap();
    }

    function maybeShowHelpOnStart() {
      const flag = localStorage.getItem(LS_HELP);
      if (flag === "hide") return;
      openHelp();
    }

    btnHelpClose.addEventListener("click", () => {
      if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
      closeHelp();
    });

    btnHelpStart.addEventListener("click", () => {
      if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
      closeHelp();
    });

    helpBackdrop.addEventListener("click", (e) => {
      if (e.target === helpBackdrop) {
        if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
        closeHelp();
      }
    });

    // ‚úÖ ESC zav√≠r√° help / leaderboard / ot√°zku (desktop)
    window.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      if (helpBackdrop.classList.contains("show")) { closeHelp(); return; }
      if (lbBox.style.display === "block") { closeLb(); return; }
      if (questionOpen) { closeModal({reason:"manual", cooldown:true}); return; }
    });

    // ===== 12) STARTUP =====
    loadState();
    updateHeader();
    updateMarkers();
    initSupabase();
    maybeShowHelpOnStart();
    startGeo();

    // ===== 13) SERVICE WORKER =====
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>














