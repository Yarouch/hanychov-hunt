<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanychov Hunt ‚Äì Prototype</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0b1220; color: #e5e7eb; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr auto auto; }
    header { padding: 12px 14px; display: flex; gap: 10px; align-items: center; justify-content: space-between; background: #111827; border-bottom: 1px solid #1f2937; }
    header .left { display:flex; gap:10px; align-items:center; }
    header h1 { font-size: 14px; margin: 0; font-weight: 700; letter-spacing: .2px; }
    header .badge { font-size: 12px; padding: 4px 8px; border: 1px solid #374151; border-radius: 999px; color: #cbd5e1; }
    #map { width: 100%; min-height: 0; }

    footer { padding: 10px 14px; background: #111827; border-top: 1px solid #1f2937; display: grid; gap: 8px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .stat { font-size: 13px; color: #cbd5e1; }
    .stat b { color: #e5e7eb; }
    button {
      appearance: none; border: 1px solid #374151; background: #0b1220; color: #e5e7eb;
      border-radius: 10px; padding: 10px 12px; font-weight: 700; font-size: 13px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    button:active { opacity: .75; }
    button.primary { background: #1d4ed8; border-color: #2563eb; color: #fff; }
    button:disabled { opacity: .4; cursor: default; }
    .muted { color: #9ca3af; font-size: 12px; }
    .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid #374151; font-size: 12px; color: #cbd5e1; cursor: pointer; }
    .pill:hover { border-color: #6b7280; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size: 12px; padding: 2px 6px; border: 1px solid #374151; border-radius: 8px; color:#cbd5e1; }

    /* Slide-up panel ot√°zky */
    #questionPanel {
      background: #111827;
      border-top: 2px solid #2563eb;
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease;
    }
    #questionPanel.open {
      max-height: 50vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .panel-inner { padding: 14px; display: grid; gap: 10px; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .panel-title { font-size: 13px; font-weight: 700; color: #93c5fd; }
    .q { font-size: 15px; font-weight: 800; line-height: 1.4; }
    .opt { display:flex; gap:10px; align-items:center; padding: 11px 12px; border: 1px solid #374151; border-radius: 10px; cursor: pointer; font-size: 14px; -webkit-tap-highlight-color: transparent; }
    .opt input { transform: scale(1.2); flex-shrink: 0; }
    .opt:hover { border-color: #6b7280; }
    .opt.selected { border-color: #2563eb; background: rgba(37,99,235,.08); }
    .timer { font-weight: 900; letter-spacing: .5px; font-size: 14px; padding: 3px 10px; border-radius: 999px; border: 1px solid #374151; color: #fbbf24; }
    .timer.urgent { color: #f87171; border-color: rgba(239,68,68,.4); }
    .result { padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; font-size: 13px; line-height: 1.5; }
    .ok  { border-color: rgba(34,197,94,.5);  background: rgba(34,197,94,.06); }
    .bad { border-color: rgba(239,68,68,.5);  background: rgba(239,68,68,.06); }
    .panel-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Leaderboard drawer */
    .drawer {
      position: fixed; right: 0; top: 0; height: 100%; width: min(420px, 92vw);
      background: #0b1220; border-left: 1px solid #1f2937;
      transform: translateX(100%); transition: transform .2s ease;
      display: grid; grid-template-rows: auto 1fr auto;
      z-index: 200;
    }
    .drawer.open { transform: translateX(0); }
    .drawer .body { padding: 14px; overflow: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #1f2937; font-size: 13px; text-align: left; }
    th { color: #cbd5e1; font-size: 12px; text-transform: uppercase; letter-spacing: .6px; }
    .lb-empty { padding: 32px 0; text-align: center; color: #6b7280; font-size: 13px; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="left">
        <h1>Hanychov Hunt</h1>
        <span id="status" class="badge">ƒåek√°m na GPS‚Ä¶</span>
      </div>
      <div class="left">
        <span class="pill" id="nickPill">P≈ôezd√≠vka: ‚Äî</span>
        <button id="btnLeaderboard">≈Ωeb≈ô√≠ƒçek</button>
      </div>
    </header>

    <div id="map"></div>

    <!-- Panel ot√°zky ‚Äî 3. ≈ô√°dek gridu, vysune se pod mapu -->
    <section id="questionPanel" aria-live="polite">
      <div class="panel-inner">
        <div class="panel-header">
          <div style="display:flex;gap:8px;align-items:center;">
            <span class="panel-title" id="pointNameBadge">‚Äî</span>
            <span class="badge" id="pointsBadge">‚Äî</span>
          </div>
          <span class="timer" id="timer">03:00</span>
        </div>
        <div class="q" id="questionText">‚Äî</div>
        <div style="display:grid;gap:7px;">
          <label class="opt"><input type="radio" name="ans" value="a"> <div><b>A)</b> <span id="optA"></span></div></label>
          <label class="opt"><input type="radio" name="ans" value="b"> <div><b>B)</b> <span id="optB"></span></div></label>
          <label class="opt"><input type="radio" name="ans" value="c"> <div><b>C)</b> <span id="optC"></span></div></label>
          <label class="opt"><input type="radio" name="ans" value="d"> <div><b>D)</b> <span id="optD"></span></div></label>
        </div>
        <div id="resultBox" class="result" style="display:none;"></div>
        <div class="panel-actions">
          <button class="primary" id="btnSubmit">Odeslat odpovƒõƒè</button>
          <button id="btnClose">Zav≈ô√≠t</button>
        </div>
      </div>
    </section>

    <footer>
      <div class="row">
        <div class="stat">Body: <b id="score">0</b></div>
        <div class="stat">U≈°et≈ôen√Ω ƒças: <b id="saved">0:00</b></div>
        <div class="stat">GPS: <b id="acc">‚Äî</b></div>
      </div>
      <div class="row">
        <button id="btnCenter">Centrovat na mƒõ</button>
        <button id="btnReset">Reset prototypu</button>
      </div>
      <div class="muted">
        Tip: Geolokace funguje na <span class="kbd">https</span> nebo <span class="kbd">localhost</span>.
      </div>
    </footer>
  </div>


  <!-- Leaderboard drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <header>
      <div class="left">
        <h1 style="margin:0;font-size:14px;">≈Ωeb≈ô√≠ƒçek üåê</h1>
        <span class="badge">Multiplayer</span>
      </div>
      <button id="btnCloseDrawer">Zav≈ô√≠t</button>
    </header>
    <div class="body">
      <p class="muted" style="margin:0 0 10px;">
        Multiplayer ≈æeb≈ô√≠ƒçek p≈ôes Supabase. Po nastaven√≠ URL a kl√≠ƒçe se v√Ωsledky sd√≠lej√≠ mezi v≈°emi hr√°ƒçi.
      </p>
      <table>
        <thead><tr><th>#</th><th>P≈ôezd√≠vka</th><th>Body</th><th>U≈°et≈ôen√Ω ƒças</th><th>Datum</th></tr></thead>
        <tbody id="lbBody"></tbody>
      </table>
    </div>
    <footer style="padding:14px; border-top:1px solid #1f2937; display:flex; gap:10px; justify-content:space-between;">
      <button id="btnSaveRun">Ulo≈æit bƒõh</button>
      <button id="btnClearLb">Smazat lok√°ln√≠</button>
    </footer>
  </aside>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Leaflet -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ===== 1) KONFIGURACE BOD≈Æ =====
    const TARGETS = [
      {
        id: "za-domovem-558",
        name: "Za Domovem 558",
        lat: 50.7394476,
        lng: 15.0092092,
        points: 100,
        question: {
          text: "Jak se jmenuje ulice, na kter√© stoj√≠ d≈Øm ƒç.p. 558?",
          options: { a: "Za Domovem", b: "Na Kopci", c: "Poln√≠", d: "Ke H≈ôi≈°ti" },
          correct: "a"
        }
      },
      {
        id: "hasicska-zbrojnice",
        name: "Hasiƒçsk√° zbrojnice",
        lat: 50.7399112,
        lng: 15.0185144,
        points: 300,
        question: {
          text: "V jak√©m roce byl zalo≈æen m√≠stn√≠ sbor dobrovoln√Ωch hasiƒç≈Ø?",
          options: { a: "1899", b: "1900", c: "1901", d: "1902" },
          correct: "c"
        }
      },
      {
        id: "spaleniste",
        name: "Sp√°leni≈°tƒõ",
        lat: 50.7402846,
        lng: 15.0169694,
        points: 500,
        question: {
          text: "V jak√©m roce vyho≈ôela m√≠stn√≠ restaurace ‚ÄûZum Walhalla"?",
          options: { a: "1918", b: "1942", c: "1945", d: "1968" },
          correct: "b"
        }
      }
    ];

    // ===== 2) SUPABASE =====
    // Vypl≈à ze sv√©ho projektu: https://app.supabase.com ‚Üí Settings ‚Üí API
    const SUPABASE_URL  = "https://TVUJ-PROJEKT.supabase.co";
    const SUPABASE_ANON = "TVUJ-ANON-KEY";
    // SQL pro tabulku (spus≈• jednou v Supabase SQL editoru):
    // CREATE TABLE leaderboard (
    //   id bigint generated always as identity primary key,
    //   nickname text not null,
    //   score integer not null default 0,
    //   saved_seconds integer not null default 0,
    //   created_at timestamptz default now()
    // );
    // ALTER TABLE leaderboard ENABLE ROW LEVEL SECURITY;
    // CREATE POLICY "read"   ON leaderboard FOR SELECT USING (true);
    // CREATE POLICY "insert" ON leaderboard FOR INSERT WITH CHECK (true);

    let sb = null;
    try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) {}
    const sbReady = SUPABASE_URL !== "https://TVUJ-PROJEKT.supabase.co";

    // ===== 3) STAV =====
    const LS_KEY = "hanychov_hunt_v3";
    const LS_LB  = "hanychov_hunt_lb_v1";

    const state = loadState() ?? {
      nickname: "",
      score: 0,
      savedSeconds: 0,
      closed:   Object.fromEntries(TARGETS.map(t => [t.id, false])),
      answered: Object.fromEntries(TARGETS.map(t => [t.id, false])),
    };

    // ===== 4) DOM =====
    const elStatus       = document.getElementById("status");
    const elScore        = document.getElementById("score");
    const elSaved        = document.getElementById("saved");
    const elAcc          = document.getElementById("acc");
    const elNickPill     = document.getElementById("nickPill");
    const pointNameBadge = document.getElementById("pointNameBadge");
    const pointsBadge    = document.getElementById("pointsBadge");
    const questionText   = document.getElementById("questionText");
    const optA = document.getElementById("optA");
    const optB = document.getElementById("optB");
    const optC = document.getElementById("optC");
    const optD = document.getElementById("optD");
    const resultBox      = document.getElementById("resultBox");
    const btnSubmit      = document.getElementById("btnSubmit");
    const btnClose       = document.getElementById("btnClose");
    const elTimer        = document.getElementById("timer");
    const drawer         = document.getElementById("drawer");
    const lbBody         = document.getElementById("lbBody");

    // ===== 5) MAPA =====
    const centerLat = TARGETS.reduce((s,t) => s+t.lat, 0) / TARGETS.length;
    const centerLng = TARGETS.reduce((s,t) => s+t.lng, 0) / TARGETS.length;
    const map = L.map("map").setView([centerLat, centerLng], 15);

    L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution: "Map data ¬© OpenStreetMap contributors | ¬© OpenTopoMap"
    }).addTo(map);

    const markerMap = {}, zoneMap = {};
    TARGETS.forEach(t => {
      markerMap[t.id] = L.marker([t.lat, t.lng]).addTo(map)
        .bindPopup(`<b>${t.name}</b><br/>${t.points} bod≈Ø`);
      zoneMap[t.id] = L.circle([t.lat, t.lng],
        { radius: 25, weight: 2, color: "#2563eb", fillOpacity: .08 }).addTo(map);
    });

    let userMarker = null, accCircle = null, lastFix = null;

    // ===== 6) HELPERY =====
    function loadState() { try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); renderStats(); renderMarkerState(); }
    function fmt(s) { return `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`; }
    function clamp(n,a,b) { return Math.max(a, Math.min(b, n)); }
    function dist(la1,lo1,la2,lo2) {
      const R=6371000, r=d=>d*Math.PI/180, dLa=r(la2-la1), dLo=r(lo2-lo1);
      const a=Math.sin(dLa/2)**2+Math.cos(r(la1))*Math.cos(r(la2))*Math.sin(dLo/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function calcR(ac) { return !ac||!isFinite(ac)?25:clamp(Math.round(ac*1.2),10,50); }
    function esc(s) { return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c])); }
    function fmtDate(ts) {
      if (!ts) return "‚Äî";
      const d = new Date(ts);
      return `${d.getDate()}.${d.getMonth()+1}. ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // ===== 7) NICKNAME (prompt ‚Äî jednoduch√© a spolehliv√©) =====
    function ensureNick() {
      if (state.nickname?.trim().length >= 2) return;
      const val = prompt("Zadej p≈ôezd√≠vku (min. 2 znaky):", state.nickname || "") ?? "";
      state.nickname = val.trim().length >= 2 ? val.trim() : "Hr√°ƒç";
      saveState();
    }
    elNickPill.addEventListener("click", () => {
      const val = prompt("Zmƒõ≈à p≈ôezd√≠vku:", state.nickname || "") ?? "";
      if (val.trim().length >= 2) { state.nickname = val.trim(); saveState(); }
    });

    // ===== 8) RENDER =====
    function renderStats() {
      elScore.textContent    = state.score;
      elSaved.textContent    = fmt(state.savedSeconds);
      elNickPill.textContent = `P≈ôezd√≠vka: ${state.nickname || "‚Äî"}`;
    }
    function renderMarkerState() {
      TARGETS.forEach(t => {
        const c = !!state.closed[t.id];
        markerMap[t.id].setOpacity(c ? 0.45 : 1);
        markerMap[t.id].bindPopup(c
          ? `<b>${t.name}</b><br/>Uzav≈ôeno ‚Äî ${state.answered[t.id] ? t.points : 0} bod≈Ø`
          : `<b>${t.name}</b><br/>${t.points} bod≈Ø`);
      });
    }
    document.querySelectorAll('input[name="ans"]').forEach(r =>
      r.addEventListener("change", () => {
        document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));
        r.closest(".opt")?.classList.add("selected");
      })
    );

    // ===== 9) PANEL OT√ÅZKY =====
    const questionPanel = document.getElementById("questionPanel");
    let timerInt = null, remaining = 180, questionOpen = false, activeTarget = null;

    function invalidateMap() { setTimeout(() => map.invalidateSize(), 320); }

    function openQuestion(target) {
      if (questionOpen || state.closed[target.id]) return;
      activeTarget = target;
      questionOpen = true;
      remaining = 180;

      resultBox.style.display = "none";
      resultBox.className = "result";
      btnSubmit.disabled = false;
      document.querySelectorAll('input[name="ans"]').forEach(r => r.checked = false);
      document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));

      pointNameBadge.textContent = target.name;
      pointsBadge.textContent    = `${target.points} bod≈Ø`;
      questionText.textContent   = target.question.text;
      optA.textContent = target.question.options.a;
      optB.textContent = target.question.options.b;
      optC.textContent = target.question.options.c;
      optD.textContent = target.question.options.d;
      elTimer.textContent = "03:00";
      elTimer.classList.remove("urgent");

      questionPanel.classList.add("open");
      invalidateMap();

      timerInt = setInterval(() => {
        remaining--;
        elTimer.textContent = fmt(remaining);
        if (remaining <= 30) elTimer.classList.add("urgent");
        if (remaining <= 0) closeAsTimeout();
      }, 1000);
    }

    function closeModal() {
      questionPanel.classList.remove("open");
      questionOpen = false;
      activeTarget = null;
      elTimer.classList.remove("urgent");
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      invalidateMap();
    }

    function closeAsTimeout() {
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      const t = activeTarget;
      state.closed[t.id] = true;
      state.answered[t.id] = false;
      resultBox.style.display = "block";
      resultBox.className = "result bad";
      resultBox.textContent = `ƒåas vypr≈°el. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;
      setTimeout(() => { closeModal(); saveState(); }, 2000);
    }

    btnSubmit.addEventListener("click", () => {
      if (btnSubmit.disabled || !activeTarget) return;
      const chosen = document.querySelector('input[name="ans"]:checked')?.value;
      if (!chosen) { alert("Vyber jednu odpovƒõƒè."); return; }
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      const t = activeTarget, ok = chosen === t.question.correct;
      if (ok) { state.score += t.points; state.savedSeconds += remaining; }
      state.answered[t.id] = ok;
      state.closed[t.id]   = true;
      resultBox.style.display = "block";
      resultBox.className = `result ${ok ? "ok" : "bad"}`;
      resultBox.textContent =
        (ok ? `Spr√°vnƒõ! +${t.points} bod≈Ø. ` : "≈†patnƒõ. +0 bod≈Ø. ") +
        `Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;
      setTimeout(() => { closeModal(); saveState(); }, 2000);
    });

    btnClose.addEventListener("click", closeModal);

    // ===== 10) GEOLOKACE =====
    function setStatus(t) { elStatus.textContent = t; }

    let gpsWatchdogTimer = null, gpsWatchId = null, gpsFirstFix = false;

    function resetGpsWatchdog() {
      if (!gpsFirstFix) return;
      if (gpsWatchdogTimer) clearTimeout(gpsWatchdogTimer);
      gpsWatchdogTimer = setTimeout(() => {
        setStatus("‚ö†Ô∏è GPS nereaguje ‚Äî klepni sem pro obnoven√≠");
        elStatus.style.cursor = "pointer";
        elStatus.style.borderColor = "#f87171";
        elStatus.onclick = restartGps;
      }, 20000);
    }

    function restartGps() {
      if (gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId);
      if (gpsWatchdogTimer) clearTimeout(gpsWatchdogTimer);
      elStatus.style.cursor = ""; elStatus.style.borderColor = ""; elStatus.onclick = null;
      gpsFirstFix = false;
      setStatus("Obnovuji GPS‚Ä¶");
      setTimeout(startWatching, 500);
    }

    function startWatching() {
      gpsWatchId = navigator.geolocation.watchPosition(pos => {
        lastFix = pos;
        if (!gpsFirstFix) { gpsFirstFix = true; setStatus("üìç GPS nalezena ‚Äî hled√°m body‚Ä¶"); }
        resetGpsWatchdog();
        elStatus.style.cursor = ""; elStatus.style.borderColor = ""; elStatus.onclick = null;

        const { latitude:la, longitude:lo, accuracy:ac } = pos.coords;
        elAcc.textContent = `${Math.round(ac)} m`;

        if (!userMarker) userMarker = L.marker([la,lo]).addTo(map).bindPopup("Ty");
        else userMarker.setLatLng([la,lo]);
        if (!accCircle) accCircle = L.circle([la,lo],{radius:ac,weight:1,color:"#94a3b8"}).addTo(map);
        else accCircle.setLatLng([la,lo]).setRadius(ac);

        const r = calcR(ac);
        TARGETS.forEach(t => zoneMap[t.id].setRadius(r));

        if (questionOpen) return;
        if (TARGETS.every(t => state.closed[t.id])) { setStatus("V≈°echny body splnƒõny! üéâ"); return; }

        let nearest = null, nearestDist = Infinity;
        for (const t of TARGETS) {
          if (state.closed[t.id]) continue;
          const d = dist(la, lo, t.lat, t.lng);
          if (d <= r) { openQuestion(t); return; }
          if (d < nearestDist) { nearestDist = d; nearest = t; }
        }
        if (nearest) setStatus(`Nejbl√≠≈æ: ${nearest.name} ‚Äî ${Math.round(nearestDist)} m (tolerance ~${r} m)`);

      }, err => {
        if (err.code === 3 && gpsFirstFix) return; // tich√© timeout po prvn√≠m fixu
        if (err.code === 1) setStatus("‚ö†Ô∏è Povolen√≠ GPS zam√≠tnuto ‚Äî povol polohu v nastaven√≠.");
        else if (err.code === 2) setStatus("‚ö†Ô∏è GPS sign√°l nedostupn√Ω ‚Äî zkus j√≠t ven.");
        else if (!gpsFirstFix) setStatus("‚è≥ GPS trv√° d√©le‚Ä¶ zkus j√≠t ven.");
      },
      { enableHighAccuracy: true, maximumAge: 3000, timeout: Infinity });
    }

    function startGeo() {
      if (!("geolocation" in navigator)) { setStatus("Geolokace nen√≠ podporov√°na."); return; }
      setStatus("Hled√°m polohu‚Ä¶");
      startWatching();
    }

    // ===== 11) LEADERBOARD =====
    function loadLbLocal() { try { return JSON.parse(localStorage.getItem(LS_LB))??[]; } catch { return []; } }
    function saveLbLocal(a) { localStorage.setItem(LS_LB, JSON.stringify(a)); }

    async function renderLb() {
      lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Naƒç√≠t√°m‚Ä¶</td></tr>`;
      let entries = [];

      if (sb && sbReady) {
        try {
          const { data, error } = await sb.from("leaderboard")
            .select("nickname,score,saved_seconds,created_at")
            .order("score", { ascending: false })
            .order("saved_seconds", { ascending: false })
            .limit(50);
          if (error) throw error;
          entries = data.map(x => ({ nickname: x.nickname, score: x.score, savedSeconds: x.saved_seconds, at: x.created_at }));
        } catch { entries = loadLbLocal(); }
      } else {
        lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty" style="color:#fbbf24">‚öôÔ∏è Nastav Supabase v k√≥du pro multiplayer.<br/><span style="color:#6b7280;font-size:11px">Zobrazuji lok√°ln√≠ z√°znamy.</span></td></tr>`;
        entries = loadLbLocal();
        if (!entries.length) return;
        entries.sort((a,b) => (b.score-a.score)||(b.savedSeconds-a.savedSeconds));
        lbBody.innerHTML += entries.map((x,i) => `<tr><td>${i+1}</td><td>${esc(x.nickname)}</td><td><b>${x.score}</b></td><td>${fmt(x.savedSeconds)}</td><td style="color:#6b7280">${fmtDate(x.at)}</td></tr>`).join("");
        return;
      }

      if (!entries.length) {
        lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">≈Ωeb≈ô√≠ƒçek je zat√≠m pr√°zdn√Ω.</td></tr>`;
        return;
      }
      lbBody.innerHTML = entries.map((x,i) => `
        <tr${i===0?' style="color:#fbbf24"':''}>
          <td>${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":i+1}</td>
          <td>${esc(x.nickname)}</td><td><b>${x.score}</b></td>
          <td>${fmt(x.savedSeconds)}</td>
          <td style="color:#6b7280">${fmtDate(x.at)}</td>
        </tr>`).join("");
    }

    let runSaved = false;
    document.getElementById("btnLeaderboard").addEventListener("click", () => {
      drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); renderLb();
    });
    document.getElementById("btnCloseDrawer").addEventListener("click", () => {
      drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true");
    });
    document.getElementById("btnSaveRun").addEventListener("click", async () => {
      if (runSaved) return;
      ensureNick();
      if (!state.nickname || state.nickname.trim().length < 2) return;
      const local = loadLbLocal();
      local.push({ nickname: state.nickname, score: state.score, savedSeconds: state.savedSeconds, at: Date.now() });
      saveLbLocal(local);
      if (sb && sbReady) {
        try {
          await sb.from("leaderboard").insert({ nickname: state.nickname, score: state.score, saved_seconds: state.savedSeconds });
          document.getElementById("btnSaveRun").textContent = "‚úì Ulo≈æeno online";
        } catch { document.getElementById("btnSaveRun").textContent = "‚úì Ulo≈æeno lok√°lnƒõ"; }
      } else {
        document.getElementById("btnSaveRun").textContent = "‚úì Ulo≈æeno lok√°lnƒõ";
      }
      renderLb(); runSaved = true;
      document.getElementById("btnSaveRun").disabled = true;
    });
    document.getElementById("btnClearLb").addEventListener("click", () => {
      if (confirm("Smazat lok√°ln√≠ z√°znamy?")) { saveLbLocal([]); renderLb(); }
    });

    // ===== 12) OVL√ÅD√ÅN√ç =====
    document.getElementById("btnCenter").addEventListener("click", () => {
      if (lastFix) map.setView([lastFix.coords.latitude, lastFix.coords.longitude], 17);
      else map.setView([centerLat, centerLng], 15);
    });
    document.getElementById("btnReset").addEventListener("click", () => {
      if (!confirm("Resetovat prototyp?")) return;
      state.score = 0; state.savedSeconds = 0;
      TARGETS.forEach(t => { state.closed[t.id]=false; state.answered[t.id]=false; });
      if (questionOpen) closeModal();
      runSaved = false;
      document.getElementById("btnSaveRun").textContent = "Ulo≈æit bƒõh";
      document.getElementById("btnSaveRun").disabled = false;
      saveState(); alert("Reset hotov.");
    });

    // ===== 13) PWA =====
    if ("serviceWorker" in navigator)
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch {}
      });

    // ===== INIT =====
    ensureNick();
    renderStats();
    renderMarkerState();
    startGeo();
    saveState();
  </script>
</body>
</html>
