<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanychov Hunt ‚Äì Prototype</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f172a;
    --muted:#94a3b8;
    --text:#e2e8f0;
    --accent:#38bdf8;
    --good:#22c55e;
    --bad:#ef4444;
    --warn:#fbbf24;
    --radius:16px;
    --shadow: 0 12px 40px rgba(0,0,0,.35);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
  }

  /* Layout */
  .app{
    position:fixed;
    inset:0;
    display:flex;
    flex-direction:column;
  }

  header{
    padding:12px 14px;
    background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.75));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(148,163,184,.18);
    display:flex;
    align-items:center;
    gap:10px;
    z-index: 30;

    /* ‚úÖ fix: na √∫zk√©m mobilu se header zalom√≠ do 2 ≈ô√°dk≈Ø */
    flex-wrap: wrap;
    row-gap: 8px;
  }

  header .title{
    font-weight:800;
    letter-spacing:.2px;
    display:flex;
    flex-direction:column;
    line-height:1.05;
    flex: 1 1 180px;
    min-width: 160px;
  }

  header .title small{
    font-weight:600;
    color:var(--muted);
    font-size:12px;
  }

  /* ‚úÖ spacer u≈æ nen√≠ pot≈ôeba (wrap layout ho nahrazuje) */
  header .spacer{ display:none; }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
    color:var(--text);
    font-size:13px;
    user-select:none;
    white-space:nowrap;
  }

  .pill b{ font-variant-numeric: tabular-nums; }

  .pill .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--accent);
    box-shadow:0 0 0 4px rgba(56,189,248,.18);
  }

  .pill.warn .dot{
    background:var(--warn);
    box-shadow:0 0 0 4px rgba(251,191,36,.18);
  }

  .pill.good .dot{
    background:var(--good);
    box-shadow:0 0 0 4px rgba(34,197,94,.18);
  }

  .pill.bad .dot{
    background:var(--bad);
    box-shadow:0 0 0 4px rgba(239,68,68,.18);
  }

  .btn{
    appearance:none;
    border:none;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(56,189,248,.16);
    color:var(--text);
    font-weight:700;
    cursor:pointer;
    border:1px solid rgba(56,189,248,.35);
    transition: transform .08s ease, background .15s ease;
    user-select:none;
  }

  .btn:active{ transform: scale(.98); }
  .btn.secondary{ background:rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.25); }
  .btn.danger{ background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }

  main{
    flex:1;
    position:relative;
  }

  #map{
    height:100%;
    width:100%;
  }

  /* ===== Leaflet layer fix ‚Äî a≈• mapa nikdy nep≈ôekryje modal ===== */
  .leaflet-pane,
  .leaflet-control,
  .leaflet-top,
  .leaflet-bottom{
    z-index: 10 !important;
  }

  .leaflet-popup{
    z-index: 20 !important;
  }

  /* status banner */
  .status{
    position:absolute;
    left:12px;
    right:12px;
    bottom:12px;
    background:rgba(15,23,42,.90);
    border:1px solid rgba(148,163,184,.20);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow: var(--shadow);
    z-index: 25;
    backdrop-filter: blur(10px);
    cursor: default; /* click target nastavujeme jen kdy≈æ je pot≈ôeba */
  }

  .status .msg{
    flex:1;
    font-size:13px;
    color:var(--text);
  }

  .status .acc{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }

  /* Question panel (bottom sheet) */
  .panel{
    position:absolute;
    left:0;
    right:0;
    bottom:-100%;
    background: rgba(15,23,42,.96);
    border-top:1px solid rgba(148,163,184,.20);
    border-radius: 18px 18px 0 0;
    padding: 14px 14px 16px;
    box-shadow: var(--shadow);
    transition: bottom .22s ease;
    z-index: 100000; /* nad mapou + nad v≈°√≠m */
    max-height: 78%;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  .panel.open{ bottom:0; }
  .panel .row{ display:flex; align-items:center; gap:10px; }
  .panel h2{ margin:10px 0 6px; font-size:18px; }

  .badge{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
    color:var(--text);
    font-size:12px;
    font-weight:700;
    white-space:nowrap;
  }

  .timer{
    margin-left:auto;
    font-weight:800;
    font-variant-numeric: tabular-nums;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.45);
  }

  .timer.urgent{
    border-color: rgba(239,68,68,.55);
    color: #fecaca;
  }

  .qtext{
    color:var(--text);
    margin:10px 0 12px;
    font-size:14px;
    line-height:1.35;
  }

  .opts{ display:grid; gap:8px; }

  label.opt{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.38);
    cursor:pointer;
    transition: background .15s ease, border-color .15s ease, transform .08s ease;
    user-select:none;
  }

  label.opt:hover{ background: rgba(2,6,23,.50); }
  label.opt:active{ transform: scale(.99); }
  label.opt input{ margin-top:2px; }
  label.opt.selected{ border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.08); }

  .result{
    margin-top:12px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.38);
    font-size:13px;
    line-height:1.35;
    display:none;
  }

  .result.good{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.08); }
  .result.bad{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.08); }

  .panel .actions{
    display:flex;
    gap:10px;
    margin-top:12px;
  }

  .panel .actions .btn{ flex:1; }

  /* Modal backdrop */
  .modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 14px;
    z-index: 99999;
  }

  /* ‚úÖ HELP MODAL tweaks */
  #helpBackdrop{ display:none; }
  #helpBackdrop.show{ display:flex; }
  #helpModal{ max-height: 85vh; overflow:auto; }

  /* leaderboard */
  .lb{
    position:absolute;
    top:12px;
    right:12px;
    width:min(360px, calc(100vw - 24px));
    background:rgba(15,23,42,.90);
    border:1px solid rgba(148,163,184,.20);
    border-radius: 16px;
    box-shadow: var(--shadow);
    z-index: 25;
    overflow:hidden;
    display:none;
    backdrop-filter: blur(10px);
  }

  .lb header{
    position:static;
    border:none;
    background:transparent;
    padding:12px 12px 10px;
  }

  .lb header .title{ font-size:14px; }
  .lb header .title small{ font-size:11px; }
  .lb .content{ padding:0 12px 12px; }

  table{ width:100%; border-collapse:collapse; font-size:12px; }
  th,td{ padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.14); text-align:left; }
  th{ color:var(--muted); font-weight:800; }
  tr:last-child td{ border-bottom:none; }
  .lb .muted{ color:var(--muted); }
  .lb-empty{ padding:10px 0; color:var(--muted); }

  /* small screens */
  @media (max-width:480px){
    header{ gap:8px; }
    .btn{ padding:10px 10px; }
    .pill{ padding:8px 9px; }

    /* ‚úÖ na mobilu: pilly se ve druh√©m ≈ô√°dku hezky rozprost≈ôou */
    .pill{ flex: 1 1 auto; }
    #btnCenter, #btnLb, #btnReset{ flex: 0 0 auto; }

    /* ‚úÖ aby "ƒåas" ≈°el v≈ædy na cel√Ω druh√Ω ≈ô√°dek, kdy≈æ je pot≈ôeba */
    #pillSaved{ flex: 1 1 100%; }
  }

  /* ===== HEADER ‚Äî pevn√© rozlo≈æen√≠ po wrapu (po≈ôad√≠ prvk≈Ø) ===== */
  header .title{ order: 1; }

  #pillScore{
    order: 2;
    margin-left: auto;   /* odtlaƒç√≠ doprava */
  }

  #pillSaved{
    order: 3;
    flex: 1 1 auto;      /* vypln√≠ ≈ô√°dek */
  }

  .btncapsule{ order: 4; }

  /* ===== Button capsule (game UI) ===== */
  .btncapsule{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
  }

  .iconbtn{
    appearance:none;
    border:none;
    width:44px;
    height:44px;
    border-radius:14px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;

    background:rgba(148,163,184,.10);
    border:1px solid rgba(148,163,184,.25);
    color:var(--text);

    transition: transform .08s ease, background .15s ease;
  }
  .iconbtn:active{ transform: scale(.98); }

  .iconbtn:hover{
    background:rgba(148,163,184,.14);
  }

  .iconbtn.danger{
    background:rgba(239,68,68,.12);
    border:1px solid rgba(239,68,68,.35);
  }
</style>

</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Hanychov Hunt
        <small>prototyp ‚Äî geolokaƒçn√≠ hra</small>
      </div>
      <div class="spacer"></div>

      <div class="pill" id="pillScore" title="Sk√≥re">
        <span class="dot"></span>
        <span>Sk√≥re: <b id="score">0</b></span>
      </div>

      <div class="pill" id="pillSaved" title="Ulo≈æen√Ω ƒças">
        <span class="dot"></span>
        <span>ƒåas: <b id="saved">0</b>s</span>
      </div>

      <div class="btncapsule" role="group" aria-label="Ovl√°d√°n√≠">
        <button class="iconbtn" id="btnCenter" title="Centrovat na mƒõ" aria-label="Centrovat">üìç</button>
        <button class="iconbtn" id="btnLb" title="Leaderboard" aria-label="Leaderboard">üèÜ</button>
        <button class="iconbtn danger" id="btnReset" title="Reset" aria-label="Reset">‚ü≤</button>
      </div>
    </header>

    <main>
      <div id="map"></div>

      <div class="status" id="statusBar">
        <div class="msg" id="statusMsg">Naƒç√≠t√°m‚Ä¶</div>
        <div class="acc">P≈ôesnost: <span id="accVal">‚Äî</span></div>
      </div>

      <div class="panel" id="questionPanel" aria-modal="true" role="dialog">
        <div class="row">
          <span class="badge" id="pointNameBadge">Bod</span>
          <span class="badge" id="pointsBadge">0 bod≈Ø</span>
          <span class="timer" id="timer">03:00</span>
        </div>
        <h2>Ot√°zka</h2>
        <div class="qtext" id="questionText">‚Ä¶</div>

        <div class="opts">
          <label class="opt"><input type="radio" name="ans" value="a"><span><b>A)</b> <span id="optA">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="b"><span><b>B)</b> <span id="optB">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="c"><span><b>C)</b> <span id="optC">‚Ä¶</span></span></label>
          <label class="opt"><input type="radio" name="ans" value="d"><span><b>D)</b> <span id="optD">‚Ä¶</span></span></label>
        </div>

        <div class="result" id="resultBox"></div>

        <div class="actions">
          <button class="btn" id="btnSubmit">Odeslat</button>
          <button class="btn secondary" id="btnClose">Zav≈ô√≠t</button>
        </div>

        <div style="margin-top:10px; color:var(--muted); font-size:11px;">
          Tip: Geolokace funguje na <b>https</b> nebo <b>localhost</b>.
        </div>
      </div>

      <div class="lb" id="lbBox">
        <header>
          <div class="title">
            Leaderboard
            <small>Top bƒõhy (lok√°lnƒõ + Supabase)</small>
          </div>
          <div class="spacer"></div>
          <button class="btn secondary" id="btnLbClose">Zav≈ô√≠t</button>
        </header>
        <div class="content">
          <div class="muted" style="font-size:11px; margin-bottom:8px;">
            Sk√≥re = body. Ulo≈æen√Ω ƒças = zbyl√© sekundy ze spr√°vn√Ωch odpovƒõd√≠.
          </div>
          <table>
            <thead>
              <tr>
                <th>#</th><th>Nick</th><th>Sk√≥re</th><th>ƒåas</th><th>Datum</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="5" class="lb-empty">Naƒç√≠t√°m‚Ä¶</td></tr>
            </tbody>
          </table>

          <div style="display:flex; gap:10px; margin-top:10px;">
            <input id="nick" placeholder="Tvoje p≈ôezd√≠vka" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.22); background:rgba(2,6,23,.35); color:var(--text); outline:none;">
            <button class="btn" id="btnSaveRun">Ulo≈æit bƒõh</button>
          </div>
          <div class="muted" style="font-size:11px; margin-top:8px;">
            Pozn.: Ulo≈æen√≠ do Supabase vy≈æaduje spr√°vnƒõ nastaven√© kl√≠ƒçe (viz JS).
          </div>
        </div>
      </div>

      <!-- ===== HELP / N√ÅVOD MODAL ===== -->
      <div class="modal-backdrop" id="helpBackdrop">
        <div class="panel" id="helpModal" style="position:relative; max-width:720px; width:min(720px, 100%); border-radius:18px; bottom:auto;">
          <div class="row" style="align-items:flex-start;">
            <span class="badge">N√°vod</span>
            <div style="flex:1"></div>
            <button class="btn secondary" id="btnHelpClose" title="Zav≈ô√≠t">‚úï</button>
          </div>

          <h2 style="margin-top:10px;">Jak hr√°t</h2>

          <div class="qtext" style="margin-top:8px;">
            <ol style="margin:0; padding-left:18px; line-height:1.5;">
              <li><b>Povol GPS</b> (poloha funguje jen na <b>HTTPS</b> nebo <b>localhost</b>).</li>
              <li>Na mapƒõ vid√≠≈° <b>kontroln√≠ body</b>. P≈ôijdi k bodu co nejbl√≠≈æ.</li>
              <li>Jakmile bude≈° v dosahu (tolerance se ≈ô√≠d√≠ p≈ôesnost√≠ GPS), otev≈ôe se <b>ot√°zka</b>.</li>
              <li>M√°≈° <b>3 minuty</b>. Za spr√°vnou odpovƒõƒè z√≠sk√°≈° <b>body</b> a ulo≈æ√≠ se ti zbyl√Ω ƒças.</li>
              <li>Spl≈à v≈°echny body a m≈Ø≈æe≈° si ulo≈æit bƒõh do <b>leaderboardu</b>.</li>
            </ol>

            <div style="margin-top:10px; color:var(--muted); font-size:12px;">
              Tip: kdy≈æ se GPS ‚Äûsekne‚Äú, klepni na status li≈°tu dole (nap≈ô. ‚ÄûGPS nereaguje‚Äú) a hra GPS restartuje.
            </div>
          </div>

          <label style="display:flex; gap:10px; align-items:center; margin-top:12px; color:var(--muted); font-size:12px; user-select:none;">
            <input type="checkbox" id="helpDontShow" />
            P≈ô√≠≈°tƒõ u≈æ nezobrazovat
          </label>

          <div class="actions" style="margin-top:12px;">
            <button class="btn" id="btnHelpStart">Rozum√≠m, jdeme hr√°t</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // ===== 0) DATA =====
    const TARGETS = [
      { id:"t1", name:"SDH HH", points: 100, lat: 50.7399112, lng: 15.0185144,
        question:{ text:"V jak√©m roce byl zalo≈æen m√≠stn√≠ sbor dobrovoln√Ωch hasiƒç≈Ø?", options:{a:"1889",b:"1902",c:"1904",d:"1906"}, correct:"b"} },
      { id:"t2", name:"Sp√°leni≈°tƒõ", points: 100, lat: 50.7402846, lng: 15.0169694,
        question:{ text:"Kdy vyho≈ôela slavn√° restaurace Zum Wallhalle?", options:{a:"1918",b:"1939",c:"1942",d:"1948"}, correct:"c"} },
      { id:"t3", name:"Lanovka", points: 100, lat: 50.7354826, lng: 15.0010897,
        question:{ text:"Kdy byla postaven√° p≈Øvodn√≠ lanovka na Je≈°tƒõd?", options:{a:"1922",b:"1933",c:"1944",d:"1955"}, correct:"b"} },
      { id:"t4", name:"Kontroln√≠ bod", points: 100, lat: 50.7398127, lng: 15.0089711,
        question:{ text:"M√°≈° se dob≈ôe?", options:{a:"ano",b:"ne",c:"nev√≠m",d:"netu≈°√≠m"}, correct:"a"} }
    ];

    // ===== 1) HELPERS =====
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const fmt = (s)=> {
      const m = Math.floor(s/60);
      const r = s%60;
      return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
    };
    function dist(lat1, lon1, lat2, lon2){
      // haversine (m)
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function calcR(ac) { return !ac||!isFinite(ac)?25:clamp(Math.round(ac*1.2),18,50); }

    // ‚úÖ XSS-safe escape for leaderboard rendering
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== 2) STATE =====
    const LS_STATE = "hh_state_v1";
    const LS_LB    = "hh_lb_v1";
    let state = {
      score: 0,
      savedSeconds: 0,
      closed: {},    // id -> bool (u≈æ vy≈ôe≈°eno)
      answered: {}   // id -> bool (spr√°vnƒõ?)
    };
    let runSaved = false;

    // init defaults (for fresh state)
    function ensureTargetDefaults(){
      TARGETS.forEach(t=>{
        if (state.closed?.[t.id] === undefined) state.closed[t.id] = false;
        if (state.answered?.[t.id] === undefined) state.answered[t.id] = false;
      });
      // guard if older state didn't have objects
      if (!state.closed || typeof state.closed !== "object") state.closed = {};
      if (!state.answered || typeof state.answered !== "object") state.answered = {};
      TARGETS.forEach(t=>{
        if (state.closed[t.id] === undefined) state.closed[t.id] = false;
        if (state.answered[t.id] === undefined) state.answered[t.id] = false;
      });
    }

    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem(LS_STATE));
        if (s && typeof s === "object") state = s;
      } catch(e){}
      // ‚úÖ merge defaults for any new targets / missing keys
      if (!state || typeof state !== "object") {
        state = { score:0, savedSeconds:0, closed:{}, answered:{} };
      }
      if (typeof state.score !== "number") state.score = 0;
      if (typeof state.savedSeconds !== "number") state.savedSeconds = 0;
      if (!state.closed || typeof state.closed !== "object") state.closed = {};
      if (!state.answered || typeof state.answered !== "object") state.answered = {};
      ensureTargetDefaults();
    }
    function saveState(){
      localStorage.setItem(LS_STATE, JSON.stringify(state));
      updateHeader();
      updateMarkers();
    }

    function resetAll(){
      if(!confirm("Opravdu resetovat postup?")) return;
      state = { score:0, savedSeconds:0, closed:{}, answered:{} };
      ensureTargetDefaults();
      if (questionOpen) closeModal({ reason:"system", cooldown:false });
      closeLb();
      closeHelp();
      runSaved = false;
      document.getElementById("btnSaveRun").textContent = "Ulo≈æit bƒõh";
      document.getElementById("btnSaveRun").disabled = false;
      saveState();
      setStatus("Reset hotov.");
      statusErrorOff();
      // po resetu klidnƒõ pokraƒçuj ve sledov√°n√≠ GPS
    }

    // ===== 3) UI refs =====
    const elScore = document.getElementById("score");
    const elSaved = document.getElementById("saved");
    const statusBar = document.getElementById("statusBar");
    const elStatus = document.getElementById("statusMsg");
    const elAcc = document.getElementById("accVal");

    const btnCenter = document.getElementById("btnCenter");
    const btnReset = document.getElementById("btnReset");
    const btnLb = document.getElementById("btnLb");

    const questionPanel = document.getElementById("questionPanel");
    const pointNameBadge = document.getElementById("pointNameBadge");
    const pointsBadge = document.getElementById("pointsBadge");
    const questionText = document.getElementById("questionText");
    const optA = document.getElementById("optA");
    const optB = document.getElementById("optB");
    const optC = document.getElementById("optC");
    const optD = document.getElementById("optD");
    const elTimer = document.getElementById("timer");
    const resultBox = document.getElementById("resultBox");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnClose = document.getElementById("btnClose");

    // leaderboard
    const lbBox = document.getElementById("lbBox");
    const lbBody = document.getElementById("lbBody");
    const btnLbClose = document.getElementById("btnLbClose");
    const nickInput = document.getElementById("nick");
    const btnSaveRun = document.getElementById("btnSaveRun");

    function updateHeader(){
      elScore.textContent = state.score;
      elSaved.textContent = state.savedSeconds;
      const pillScore = document.getElementById("pillScore");
      const pillSaved = document.getElementById("pillSaved");
      pillScore.classList.toggle("good", state.score>0);
      pillSaved.classList.toggle("good", state.savedSeconds>0);
    }

    // ===== 4) MAP =====
    let map = L.map("map", { zoomControl:true }).setView([TARGETS[0].lat, TARGETS[0].lng], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const zoneMap = {};
    const markerMap = {};

    TARGETS.forEach(t=>{
      const m = L.circleMarker([t.lat,t.lng],{
        radius:10, weight:2, color:"#38bdf8", fillColor:"#38bdf8", fillOpacity:.25
      }).addTo(map).bindPopup(`<b>${escapeHtml(t.name)}</b><br>${t.points} bod≈Ø`);
      markerMap[t.id]=m;

      const z = L.circle([t.lat,t.lng],{
        radius: 25, weight:1, color:"#94a3b8", fillColor:"#94a3b8", fillOpacity:.08
      }).addTo(map);
      zoneMap[t.id]=z;
    });

    let userMarker = null;
    let accCircle  = null;
    let lastFix = null;

    function updateMarkers(){
      TARGETS.forEach(t=>{
        const done = !!state.closed[t.id];
        const ok = !!state.answered[t.id];
        const m = markerMap[t.id];
        if(done){
          m.setStyle({
            color: ok ? "#22c55e" : "#ef4444",
            fillColor: ok ? "#22c55e" : "#ef4444",
            fillOpacity:.35
          });
        } else {
          m.setStyle({ color:"#38bdf8", fillColor:"#38bdf8", fillOpacity:.25 });
        }
      });
    }

    function invalidateMap(){
      // Leaflet pot≈ôebuje p≈ôi p≈ôekryt√≠ UI obƒças p≈ôepoƒç√≠tat velikost
      setTimeout(()=>map.invalidateSize(), 120);
    }

    btnCenter.addEventListener("click", ()=>{
      if(lastFix){
        map.setView([lastFix.coords.latitude, lastFix.coords.longitude], 17, {animate:true});
      } else {
        map.fitBounds(L.latLngBounds(TARGETS.map(t=>[t.lat,t.lng])).pad(0.2));
      }
    });

    btnReset.addEventListener("click", resetAll);

    // ===== 5) QUESTION FLOW =====
    let timerInt = null, remaining = 180, questionOpen = false, activeTarget = null;
    let questionCooldownUntil = 0; // ms timestamp
    const QUESTION_COOLDOWN_MS = 6000;

    // highlight selected option
    document.querySelectorAll('input[name="ans"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        document.querySelectorAll(".opt").forEach(l=>l.classList.remove("selected"));
        r.closest(".opt").classList.add("selected");
      });
    });

    function openQuestion(target) {
      if (questionOpen || state.closed[target.id]) return;

      // kdy≈æ se otev√≠r√° ot√°zka, zav≈ôi LB/Help + popupy
      closeLb();
      closeHelp();
      try { map.closePopup(); } catch(e){}

      activeTarget = target;
      questionOpen = true;
      remaining = 180;

      resultBox.style.display = "none";
      resultBox.className = "result";
      btnSubmit.disabled = false;
      document.querySelectorAll('input[name="ans"]').forEach(r => r.checked = false);
      document.querySelectorAll(".opt").forEach(l => l.classList.remove("selected"));

      pointNameBadge.textContent = target.name;
      pointsBadge.textContent    = `${target.points} bod≈Ø`;
      questionText.textContent   = target.question.text;
      optA.textContent = target.question.options.a;
      optB.textContent = target.question.options.b;
      optC.textContent = target.question.options.c;
      optD.textContent = target.question.options.d;
      elTimer.textContent = "03:00";
      elTimer.classList.remove("urgent");

      questionPanel.classList.add("open");
      invalidateMap();

      timerInt = setInterval(() => {
        remaining--;
        elTimer.textContent = fmt(remaining);
        if (remaining <= 30) elTimer.classList.add("urgent");
        if (remaining <= 0) closeAsTimeout();
      }, 1000);
    }

    function closeModal({reason="manual", cooldown=true} = {}) {
      // cooldown pouze p≈ôi manu√°ln√≠m zav≈ôen√≠ (lep≈°√≠ UX)
      if (cooldown && reason === "manual") {
        questionCooldownUntil = Date.now() + QUESTION_COOLDOWN_MS;
      }

      questionPanel.classList.remove("open");
      questionOpen = false;
      activeTarget = null;
      elTimer.classList.remove("urgent");
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      invalidateMap();
    }

    function closeAsTimeout() {
      if (timerInt) { clearInterval(timerInt); timerInt = null; }
      const t = activeTarget;
      if (!t) return;

      state.closed[t.id] = true;
      state.answered[t.id] = false;

      resultBox.style.display = "block";
      resultBox.className = "result bad";
      resultBox.textContent = `ƒåas vypr≈°el. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;

      setTimeout(() => {
        closeModal({reason:"system", cooldown:false});
        saveState();
        maybeStopGpsIfDone();
      }, 2000);
    }

    btnSubmit.addEventListener("click", () => {
      if (btnSubmit.disabled || !activeTarget) return;
      const chosen = document.querySelector('input[name="ans"]:checked')?.value;
      if (!chosen) { alert("Vyber jednu odpovƒõƒè."); return; }
      if (timerInt) { clearInterval(timerInt); timerInt = null; }

      const t = activeTarget, ok = chosen === t.question.correct;
      if (ok) { state.score += t.points; state.savedSeconds += remaining; }

      state.answered[t.id] = ok;
      state.closed[t.id]   = true;

      resultBox.style.display = "block";
      resultBox.className = `result ${ok ? "good":"bad"}`;
      resultBox.textContent = ok
        ? `Spr√°vnƒõ! +${t.points} bod≈Ø a +${remaining}s ulo≈æen√©ho ƒçasu.`
        : `≈†patnƒõ. +0 bod≈Ø. Spr√°vn√° odpovƒõƒè: ${t.question.correct.toUpperCase()}) ${t.question.options[t.question.correct]}.`;
      btnSubmit.disabled = true;

      setTimeout(() => {
        closeModal({reason:"system", cooldown:false});
        saveState();
        maybeStopGpsIfDone();
      }, 2000);
    });

    btnClose.addEventListener("click", () => closeModal({reason:"manual", cooldown:true}));

    // ===== 10) GEOLOKACE =====
    function setStatus(t) { elStatus.textContent = t; }

    function statusErrorOn() {
      if (!statusBar) return;
      statusBar.style.borderColor = "#ef4444";
      statusBar.style.boxShadow = "0 0 0 2px rgba(239,68,68,.35)";
    }

    function statusErrorOff() {
      if (!statusBar) return;
      statusBar.style.borderColor = "";
      statusBar.style.boxShadow = "";
    }

    function setStatusClickable(enabled, handler){
      if (!statusBar) return;
      if (enabled) {
        statusBar.style.cursor = "pointer";
        statusBar.onclick = handler;
      } else {
        statusBar.style.cursor = "default";
        statusBar.onclick = null;
      }
    }

    let gpsWatchdogTimer = null, gpsWatchId = null, gpsFirstFix = false;
    let lastFixAt = 0; // ms timestamp posledn√≠ho platn√©ho fixu

    function resetGpsWatchdog() {
      if (gpsWatchdogTimer) clearTimeout(gpsWatchdogTimer);

      gpsWatchdogTimer = setTimeout(() => {
        const age = lastFixAt ? (Date.now() - lastFixAt) : Infinity;

        // Pokud u≈æ m√°me fix a posledn√≠ fix nen√≠ "star√Ω", nic nehla≈°
        if (gpsFirstFix && age < 30000) { // 30s tolerance
          resetGpsWatchdog();
          return;
        }

        // Teprve teƒè hl√°s√≠me probl√©m
        statusErrorOn();
        setStatus(gpsFirstFix
          ? "‚ö†Ô∏è GPS chv√≠li neaktualizuje ‚Äî klepni sem pro obnoven√≠"
          : "‚è≥ ƒåek√°m na GPS‚Ä¶ trv√° to d√©le ‚Äî klepni sem pro obnoven√≠"
        );
        setStatusClickable(true, restartGps);
      }, 20000);
    }

    function stopWatching(){
      if (gpsWatchId !== null) {
        try { navigator.geolocation.clearWatch(gpsWatchId); } catch(e){}
        gpsWatchId = null;
      }
      if (gpsWatchdogTimer) { clearTimeout(gpsWatchdogTimer); gpsWatchdogTimer = null; }
      setStatusClickable(false, null);
    }

    function maybeStopGpsIfDone(){
      if (TARGETS.every(t => !!state.closed[t.id])) {
        setStatus("V≈°echny body splnƒõny! üéâ (GPS vypnuta)");
        statusErrorOff();
        stopWatching();
      }
    }

    function restartGps() {
      stopWatching();
      gpsFirstFix = false;
      lastFixAt = 0;
      statusErrorOff();
      setStatus("Obnovuji GPS‚Ä¶");
      setStatusClickable(true, restartGps);
      resetGpsWatchdog();
      setTimeout(startWatching, 500);
    }

    function startWatching() {
      if (!("geolocation" in navigator)) {
        statusErrorOn();
        setStatus("Geolokace nen√≠ podporov√°na.");
        setStatusClickable(false, null);
        return;
      }

      gpsWatchId = navigator.geolocation.watchPosition(pos => {
        lastFix = pos;
        lastFixAt = Date.now();

        if (!gpsFirstFix) {
          gpsFirstFix = true;
          statusErrorOff();
          setStatus("üìç GPS nalezena ‚Äî hled√°m body‚Ä¶");
        }

        resetGpsWatchdog();
        setStatusClickable(false, null);
        statusErrorOff();

        const { latitude:la, longitude:lo, accuracy:ac } = pos.coords;
        elAcc.textContent = `${Math.round(ac)} m`;

        if (!userMarker) userMarker = L.marker([la,lo]).addTo(map).bindPopup("Ty");
        else userMarker.setLatLng([la,lo]);

        if (!accCircle) accCircle = L.circle([la,lo],{radius:ac,weight:1,color:"#94a3b8"}).addTo(map);
        else accCircle.setLatLng([la,lo]).setRadius(ac);

        const r = calcR(ac);
        TARGETS.forEach(t => zoneMap[t.id].setRadius(r));

        // hotovo? m≈Ø≈æeme vypnout GPS
        if (TARGETS.every(t => !!state.closed[t.id])) {
          maybeStopGpsIfDone();
          return;
        }

        if (questionOpen) return;
        if (Date.now() < questionCooldownUntil) return;

        // ‚úÖ lep≈°√≠ UX: vyber nejbli≈æ≈°√≠ target v dosahu (ne prvn√≠ v seznamu)
        let nearest = null, nearestDist = Infinity;
        let inRangeNearest = null, inRangeDist = Infinity;

        for (const t of TARGETS) {
          if (state.closed[t.id]) continue;
          const d = dist(la, lo, t.lat, t.lng);

          if (d < nearestDist) { nearestDist = d; nearest = t; }
          if (d <= r && d < inRangeDist) { inRangeDist = d; inRangeNearest = t; }
        }

        if (inRangeNearest) {
          openQuestion(inRangeNearest);
          return;
        }

        if (nearest) setStatus(`Nejbl√≠≈æ: ${nearest.name} ‚Äî ${Math.round(nearestDist)} m (tolerance ~${r} m)`);

      }, err => {
        // u watchPosition se m≈Ø≈æe vracet TIMEOUT (code 3). Po prvn√≠m fixu ho ignorujeme,
        // proto≈æe GPS m≈Ø≈æe d√°l fungovat a jen vypadne jeden update.
        if (err.code === 3 && gpsFirstFix) return;

        statusErrorOn();

        if (err.code === 1) setStatus("‚ö†Ô∏è Povolen√≠ GPS zam√≠tnuto ‚Äî povol polohu v nastaven√≠ prohl√≠≈æeƒçe.");
        else if (err.code === 2) setStatus("‚ö†Ô∏è GPS sign√°l nedostupn√Ω ‚Äî zkus j√≠t ven nebo zapnout/vypnout GPS.");
        else setStatus(gpsFirstFix ? "‚ö†Ô∏è GPS timeout ‚Äî klepni pro restart" : "‚è≥ ƒåek√°m na GPS‚Ä¶ trv√° to d√©le ‚Äî klepni pro restart");

        setStatusClickable(true, restartGps);
        resetGpsWatchdog();
      },
      { enableHighAccuracy: true, maximumAge: 3000, timeout: 20000 });
    }

    function startGeo() {
      if (!("geolocation" in navigator)) {
        statusErrorOn();
        setStatus("Geolokace nen√≠ podporov√°na.");
        return;
      }
      setStatus("Hled√°m polohu‚Ä¶");
      statusErrorOff();
      // U≈æivatel m≈Ø≈æe restart vyvolat i hned klikem na status bar
      setStatusClickable(true, restartGps);
      resetGpsWatchdog();
      startWatching();
    }

    // ===== 11) LEADERBOARD =====
    const SUPABASE_URL = "";       // nap≈ô. https://xyzcompany.supabase.co
    const SUPABASE_ANON_KEY = "";  // anon key
    let sb = null, sbReady = false;

    async function initSupabase(){
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
      try{
        const mod = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
        sb = mod.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        sbReady = true;
      }catch(e){
        console.warn("Supabase init failed", e);
      }
    }

    function loadLbLocal() { try { return JSON.parse(localStorage.getItem(LS_LB)) ?? []; } catch { return []; } }
    function saveLbLocal(a) { localStorage.setItem(LS_LB, JSON.stringify(a)); }

    async function renderLb() {
      lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Naƒç√≠t√°m‚Ä¶</td></tr>`;
      let entries = [];

      if (sb && sbReady) {
        try {
          const { data, error } = await sb.from("leaderboard")
            .select("nickname,score,saved_seconds,created_at")
            .order("score", { ascending: false })
            .order("saved_seconds", { ascending: false })
            .limit(20);

          if (!error && data) entries = data.map(x => ({
            nickname: x.nickname,
            score: x.score,
            saved_seconds: x.saved_seconds,
            created_at: x.created_at
          }));
        } catch (e) {
          console.warn("LB fetch failed", e);
        }
      }

      // merge with local as fallback
      const local = loadLbLocal();
      const merged = [...entries, ...local]
        .sort((a,b)=> b.score - a.score || b.saved_seconds - a.saved_seconds)
        .slice(0,20);

      if (!merged.length) {
        lbBody.innerHTML = `<tr><td colspan="5" class="lb-empty">Zat√≠m ≈æ√°dn√© ulo≈æen√© bƒõhy.</td></tr>`;
        return;
      }

      // ‚úÖ XSS-safe rendering
      lbBody.innerHTML = merged.map((x,i)=>{
        const d = x.created_at ? new Date(x.created_at) : null;
        const dateStr = d ? d.toLocaleDateString("cs-CZ") : "‚Äî";
        const nick = escapeHtml((x.nickname || "‚Äî").slice(0,16));
        const score = Number(x.score ?? 0);
        const saved = Number(x.saved_seconds ?? 0);
        return `<tr>
          <td>${i+1}</td>
          <td>${nick}</td>
          <td><b>${score}</b></td>
          <td>${saved}s</td>
          <td>${escapeHtml(dateStr)}</td>
        </tr>`;
      }).join("");
    }

    function openLb(){
      // zav≈ôi jin√© UI vrstvy
      if (questionOpen) closeModal({reason:"system", cooldown:false});
      closeHelp();
      try { map.closePopup(); } catch(e){}

      lbBox.style.display = "block";
      renderLb();
      invalidateMap();
    }
    function closeLb(){
      lbBox.style.display = "none";
      invalidateMap();
    }
    btnLb.addEventListener("click", ()=> lbBox.style.display==="block" ? closeLb() : openLb() );
    btnLbClose.addEventListener("click", closeLb);

    btnSaveRun.addEventListener("click", async ()=>{
      if (runSaved) return;

      const nick = (nickInput.value || "").trim() || "Anonym";
      const entry = {
        nickname: nick,
        score: state.score,
        saved_seconds: state.savedSeconds,
        created_at: new Date().toISOString()
      };

      // local
      const local = loadLbLocal();
      local.push(entry);
      saveLbLocal(local);

      // supabase (optional)
      if (sb && sbReady) {
        try {
          await sb.from("leaderboard").insert({
            nickname: entry.nickname,
            score: entry.score,
            saved_seconds: entry.saved_seconds
          });
        } catch(e){
          console.warn("Supabase insert failed", e);
        }
      }

      runSaved = true;
      btnSaveRun.textContent = "Ulo≈æeno ‚úÖ";
      btnSaveRun.disabled = true;
      renderLb();
    });

    // ===== HELP / N√ÅVOD =====
    const LS_HELP = "hh_help_v1";
    const helpBackdrop = document.getElementById("helpBackdrop");
    const btnHelpClose  = document.getElementById("btnHelpClose");
    const btnHelpStart  = document.getElementById("btnHelpStart");
    const helpDontShow  = document.getElementById("helpDontShow");

    function openHelp() {
      // zav≈ôi ostatn√≠ vrstvy (a≈• se UI nep≈ôekr√Ωv√°)
      if (questionOpen) closeModal({reason:"system", cooldown:false});
      closeLb();

      // zav≈ôi p≈ô√≠padn√© Leaflet popupy
      try { map.closePopup(); } catch(e) {}

      helpBackdrop.classList.add("show");
      document.body.style.overflow = "hidden";
      invalidateMap();
    }

    function closeHelp() {
      helpBackdrop.classList.remove("show");
      document.body.style.overflow = "hidden";
      invalidateMap();
    }

    function maybeShowHelpOnStart() {
      const flag = localStorage.getItem(LS_HELP);
      if (flag === "hide") return;
      openHelp();
    }

    btnHelpClose.addEventListener("click", () => {
      if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
      closeHelp();
    });

    btnHelpStart.addEventListener("click", () => {
      if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
      closeHelp();
    });

    // klik mimo okno zav≈ôe (voliteln√©)
    helpBackdrop.addEventListener("click", (e) => {
      if (e.target === helpBackdrop) {
        if (helpDontShow.checked) localStorage.setItem(LS_HELP, "hide");
        closeHelp();
      }
    });

    // ‚úÖ ESC zav√≠r√° help / leaderboard / ot√°zku (desktop)
    window.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      if (helpBackdrop.classList.contains("show")) { closeHelp(); return; }
      if (lbBox.style.display === "block") { closeLb(); return; }
      if (questionOpen) { closeModal({reason:"manual", cooldown:true}); return; }
    });

    // ===== 12) STARTUP =====
    loadState();
    updateHeader();
    updateMarkers();
    initSupabase();
    maybeShowHelpOnStart();
    startGeo();

    // ===== 13) SERVICE WORKER =====
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
